<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tourist Dashboard - Smart Tourist Safety System</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1 data-translate="tourist_dashboard">Tourist Dashboard</h1>
            <div class="user-info">
                <span data-translate="welcome_user">Welcome,</span> <strong>{{ tourist_name }}</strong>
                <span class="tourist-id-badge">ID: {{ tourist_id }}</span>
            </div>
            <div class="header-controls">
                <div class="language-selector">
                    <select id="language-select" onchange="switchLanguage(this.value)" class="language-dropdown">
                        <option value="en">English</option>
                        <option value="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä</option>
                        <option value="ta">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</option>
                        <option value="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</option>
                        <option value="bn">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</option>
                        <option value="mr">‡§Æ‡§∞‡§æ‡§†‡•Ä</option>
                        <option value="gu">‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä</option>
                        <option value="kn">‡≤ï‡≤®‡≥ç‡≤®‡≤°</option>
                        <option value="ml">‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç</option>
                        <option value="pa">‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä</option>
                        <option value="or">‡¨ì‡¨°‡¨º‡¨ø‡¨Ü</option>
                        <option value="as">‡¶Ö‡¶∏‡¶Æ‡ßÄ‡¶Ø‡¶º‡¶æ</option>
                    </select>
                </div>
                <div class="emergency-quick-access">
                    <button onclick="callEmergency('100')" class="emergency-quick-btn police-btn" title="Police - 100">üöî</button>
                    <button onclick="callEmergency('108')" class="emergency-quick-btn ambulance-btn" title="Ambulance - 108">üöë</button>
                    <button onclick="callEmergency('101')" class="emergency-quick-btn fire-btn" title="Fire - 101">üöí</button>
                </div>
            </div>
        </header>

        <div class="main-content">
            <div class="back-link">
                <a href="/" data-translate="back_home">‚Üê Back to Home</a>
            </div>

            <!-- Emergency Panic Button -->
            <div class="panic-section">
                <div class="panic-container">
                    <button id="panic-button" class="panic-btn enhanced-panic" onclick="confirmPanicAlert()">
                        <div class="panic-pulse"></div>
                        <span class="panic-icon">üö®</span>
                        <span class="panic-text" data-translate="panic_button">üö® EMERGENCY PANIC BUTTON</span>
                        <div class="panic-shine"></div>
                    </button>
                    <div class="panic-instructions">
                        <p class="panic-description" data-translate="panic_description">
                            Click this button in case of emergency. Your location will be immediately sent to authorities.
                        </p>
                        <div class="panic-tips">
                            <small>‚Ä¢ Hold for 3 seconds to activate</small>
                            <small>‚Ä¢ Double-tap for silent alert</small>
                            <small>‚Ä¢ Your location will be shared automatically</small>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Emergency Actions -->
                <div class="emergency-quick-actions">
                    <h4>Quick Emergency Actions</h4>
                    <div class="quick-emergency-grid">
                        <button onclick="callEmergency('100')" class="quick-emergency-btn police">
                            <span class="emergency-icon">üöî</span>
                            <span class="emergency-label">Police<br><small>100</small></span>
                        </button>
                        <button onclick="callEmergency('108')" class="quick-emergency-btn ambulance">
                            <span class="emergency-icon">üöë</span>
                            <span class="emergency-label">Ambulance<br><small>108</small></span>
                        </button>
                        <button onclick="callEmergency('101')" class="quick-emergency-btn fire">
                            <span class="emergency-icon">üöí</span>
                            <span class="emergency-label">Fire<br><small>101</small></span>
                        </button>
                        <button onclick="sendSilentAlert()" class="quick-emergency-btn silent">
                            <span class="emergency-icon">üîá</span>
                            <span class="emergency-label">Silent<br><small>Alert</small></span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Location Status -->
            <div class="status-section">
                <div class="status-card">
                    <h3 data-translate="location_status">Location Status</h3>
                    <div id="location-info">
                        <p data-translate="getting_location">Getting your location...</p>
                    </div>
                    <button onclick="updateLocation()" class="btn btn-secondary" data-translate="update_location">Update Location</button>
                </div>

                <div class="status-card">
                    <h3 data-translate="safety_status">Safety Status</h3>
                    <div id="safety-status" class="safety-indicator safe">
                        <span class="status-icon">‚úÖ</span>
                        <span data-translate="status_safe">Safe</span>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <h3 data-translate="quick_actions">Quick Actions</h3>
                <div class="action-buttons">
                    <button onclick="shareLocation()" class="btn btn-outline" data-translate="share_location">Share Location</button>
                    <button onclick="viewLocationHistory()" class="btn btn-outline" data-translate="location_history">Location History</button>
                    <button onclick="emergencyContacts()" class="btn btn-outline" data-translate="emergency_contacts">Emergency Contacts</button>
                </div>
            </div>

            <!-- Alerts and Notifications -->
            <div class="alerts-section">
                <h3 data-translate="alerts_notifications">Alerts & Notifications</h3>
                <div id="alerts-container">
                    <p data-translate="no_alerts">No alerts at this time.</p>
                </div>
            </div>

            <!-- Emergency Contacts -->
            <div class="emergency-info">
                <h3 data-translate="emergency_numbers">Emergency Numbers</h3>
                <div class="emergency-grid">
                    <div class="emergency-item">
                        <strong data-translate="police">Police:</strong> 
                        <a href="tel:100">100</a>
                    </div>
                    <div class="emergency-item">
                        <strong data-translate="ambulance">Ambulance:</strong> 
                        <a href="tel:108">108</a>
                    </div>
                    <div class="emergency-item">
                        <strong data-translate="fire">Fire Service:</strong> 
                        <a href="tel:101">101</a>
                    </div>
                    <div class="emergency-item">
                        <strong data-translate="tourist_helpline">Tourist Helpline:</strong> 
                        <a href="tel:1363">1363</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='common.js') }}"></script>
    <script>
        const touristId = parseInt('{{ tourist_id }}');
        let currentLocation = null;

        // Get location on page load
        window.addEventListener('load', function() {
            updateLocation();
            startLocationTracking();
        });

        function updateLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        currentLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                        
                        updateLocationDisplay();
                        sendLocationUpdate();
                    },
                    function(error) {
                        console.error('Error getting location:', error);
                        document.getElementById('location-info').innerHTML = 
                            `<p class="error">${translations[currentLanguage].location_error || 'Unable to get location'}</p>`;
                    }
                );
            } else {
                document.getElementById('location-info').innerHTML = 
                    `<p class="error">${translations[currentLanguage].geolocation_not_supported || 'Geolocation is not supported'}</p>`;
            }
        }

        function updateLocationDisplay() {
            if (currentLocation) {
                document.getElementById('location-info').innerHTML = `
                    <p><strong>${translations[currentLanguage].latitude || 'Latitude'}:</strong> ${currentLocation.latitude.toFixed(6)}</p>
                    <p><strong>${translations[currentLanguage].longitude || 'Longitude'}:</strong> ${currentLocation.longitude.toFixed(6)}</p>
                    <p><strong>${translations[currentLanguage].last_updated || 'Last Updated'}:</strong> ${new Date().toLocaleString()}</p>
                `;
            }
        }

        async function sendLocationUpdate() {
            if (!currentLocation) return;

            try {
                const response = await fetch('/api/update_location', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        tourist_id: touristId,
                        latitude: currentLocation.latitude,
                        longitude: currentLocation.longitude
                    })
                });

                const result = await response.json();
                
                if (result.geofence_violation) {
                    showGeofenceAlert(result.geofence_violation);
                }
            } catch (error) {
                console.error('Error updating location:', error);
            }
        }

        async function confirmPanicAlert() {
            const confirmMessage = translations[currentLanguage].panic_button_confirm || 'Are you sure you want to send an emergency alert?';
            
            if (confirm(confirmMessage)) {
                await sendPanicAlert();
            }
        }

        async function sendPanicAlert() {
            if (!currentLocation) {
                alert(translations[currentLanguage].location_required || 'Please allow location access first');
                updateLocation();
                return;
            }

            const panicButton = document.getElementById('panic-button');
            panicButton.disabled = true;
            panicButton.classList.add('sending');
            panicButton.innerHTML = `
                <span class="panic-icon">‚è≥</span>
                <span>Sending Emergency Alert...</span>
            `;

            // Play alert sound if available
            playAlertSound();

            try {
                const response = await fetch('/api/panic_alert', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        tourist_id: touristId,
                        latitude: currentLocation.latitude,
                        longitude: currentLocation.longitude
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showAlert(translations[currentLanguage].panic_sent || 'üö® Emergency alert sent successfully! Help is on the way!', 'success');
                    
                    // Show emergency contacts
                    showEmergencyContactsModal();
                    
                    if (result.geofence_violation) {
                        showGeofenceAlert(result.geofence_violation);
                    }
                } else {
                    showAlert(translations[currentLanguage].panic_failed || 'Failed to send alert. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Error sending panic alert:', error);
                showAlert(translations[currentLanguage].network_error || 'Network error. Please try again.', 'error');
            } finally {
                panicButton.disabled = false;
                panicButton.classList.remove('sending');
                panicButton.innerHTML = `
                    <div class="panic-pulse"></div>
                    <span class="panic-icon">üö®</span>
                    <span class="panic-text" data-translate="panic_button">üö® EMERGENCY PANIC BUTTON</span>
                    <div class="panic-shine"></div>
                `;
            }
        }

        async function sendSilentAlert() {
            if (!currentLocation) {
                alert(translations[currentLanguage].location_required || 'Please allow location access first');
                updateLocation();
                return;
            }

            try {
                const response = await fetch('/api/panic_alert', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        tourist_id: touristId,
                        latitude: currentLocation.latitude,
                        longitude: currentLocation.longitude,
                        silent: true
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    // Silent notification - no sound or popup
                    const notification = document.createElement('div');
                    notification.className = 'silent-notification';
                    notification.textContent = '‚úì Silent alert sent';
                    document.body.appendChild(notification);
                    
                    setTimeout(() => notification.remove(), 3000);
                }
            } catch (error) {
                console.error('Error sending silent alert:', error);
            }
        }

        function callEmergency(number) {
            if (confirm(`Call emergency number ${number}?`)) {
                window.location.href = `tel:${number}`;
                
                // Log the emergency call
                logEmergencyAction(`Called ${number}`);
            }
        }

        function playAlertSound() {
            // Create audio context for alert sound
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 1);
            } catch (error) {
                console.log('Audio not supported');
            }
        }

        function showEmergencyContactsModal() {
            const modal = document.createElement('div');
            modal.className = 'emergency-modal';
            modal.innerHTML = `
                <div class="emergency-modal-content">
                    <h3>üö® Emergency Alert Sent!</h3>
                    <p>Your location has been shared with emergency services.</p>
                    <div class="emergency-contacts-list">
                        <h4>Quick Emergency Contacts:</h4>
                        <button onclick="callEmergency('100')" class="modal-emergency-btn">üöî Police (100)</button>
                        <button onclick="callEmergency('108')" class="modal-emergency-btn">üöë Ambulance (108)</button>
                        <button onclick="callEmergency('101')" class="modal-emergency-btn">üöí Fire (101)</button>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="close-modal-btn">Close</button>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Auto-close after 10 seconds
            setTimeout(() => {
                if (modal.parentElement) {
                    modal.remove();
                }
            }, 10000);
        }

        function logEmergencyAction(action) {
            const log = {
                tourist_id: touristId,
                action: action,
                timestamp: new Date().toISOString(),
                location: currentLocation
            };
            
            // Store in local storage for backup
            const logs = JSON.parse(localStorage.getItem('emergency_logs') || '[]');
            logs.push(log);
            localStorage.setItem('emergency_logs', JSON.stringify(logs.slice(-10))); // Keep last 10 logs
        }

        function showGeofenceAlert(zoneName) {
            const safetyStatus = document.getElementById('safety-status');
            safetyStatus.className = 'safety-indicator danger';
            safetyStatus.innerHTML = `
                <span class="status-icon">‚ö†Ô∏è</span>
                <span>${translations[currentLanguage].danger_zone || 'Danger Zone'}: ${zoneName}</span>
            `;
            
            showAlert(`${translations[currentLanguage].entered_danger_zone || 'You have entered a danger zone'}: ${zoneName}`, 'warning');
        }

        function showAlert(message, type) {
            const alertsContainer = document.getElementById('alerts-container');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" class="close-btn">√ó</button>
            `;
            alertsContainer.appendChild(alertDiv);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        function startLocationTracking() {
            // Update location every 5 minutes
            setInterval(updateLocation, 5 * 60 * 1000);
        }

        function shareLocation() {
            if (currentLocation && navigator.share) {
                navigator.share({
                    title: 'My Current Location',
                    text: `I am currently at: ${currentLocation.latitude}, ${currentLocation.longitude}`,
                    url: `https://maps.google.com/?q=${currentLocation.latitude},${currentLocation.longitude}`
                });
            } else if (currentLocation) {
                const url = `https://maps.google.com/?q=${currentLocation.latitude},${currentLocation.longitude}`;
                navigator.clipboard.writeText(url).then(() => {
                    showAlert(translations[currentLanguage].location_copied || 'Location link copied to clipboard!', 'success');
                });
            }
        }

        function viewLocationHistory() {
            // This would open a modal or navigate to location history page
            showAlert(translations[currentLanguage].feature_coming_soon || 'Feature coming soon!', 'info');
        }

        function emergencyContacts() {
            // Scroll to emergency contacts section
            document.querySelector('.emergency-info').scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>