<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard - Document Management</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    
    <!-- üó∫Ô∏è Leaflet.js for Interactive Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        /* üé® IMPROVED UI/UX STYLES */
        
        .user-dashboard {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
            background: #f5f7fa;
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 40px;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.25);
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .dashboard-card {
            background: white;
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            border: 1px solid #e8ecef;
            transition: all 0.3s ease;
        }
        
        .dashboard-card:hover {
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            transform: translateY(-4px);
        }
        
        .card-title {
            font-size: 1.35em;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f3f5;
        }
        
        .card-icon {
            font-size: 1.8em;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }
        
        /* üéØ TABBED INTERFACE STYLES */
        .tabs-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 40px;
            overflow: hidden;
        }
        
        .tabs-header {
            display: flex;
            background: linear-gradient(to right, #f8f9fa, #e9ecef);
            border-bottom: 2px solid #dee2e6;
            overflow-x: auto;
        }
        
        .tab-button {
            flex: 1;
            min-width: 150px;
            padding: 20px 24px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1.05em;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
        }
        
        .tab-button:hover {
            background: rgba(102, 126, 234, 0.08);
            color: #667eea;
        }
        
        .tab-button.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }
        
        .tab-button .tab-icon {
            font-size: 1.3em;
        }
        
        .tab-content {
            display: none;
            padding: 32px;
            animation: fadeIn 0.4s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* üé® COLOR-CODED STATUS INDICATORS */
        .status-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Green = Safe */
        .status-safe, .status-approved, .status-active {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        /* Red = Danger */
        .status-danger, .status-rejected, .status-critical {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* Yellow = Warning */
        .status-warning, .status-pending, .status-review {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        /* Blue = Info */
        .status-info, .status-processing {
            background: linear-gradient(135deg, #d1ecf1, #bee5eb);
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        /* üéØ CONSISTENT ICON SYSTEM */
        .icon-safe::before { content: "‚úÖ "; }
        .icon-danger::before { content: "üö® "; }
        .icon-warning::before { content: "‚ö†Ô∏è "; }
        .icon-info::before { content: "‚ÑπÔ∏è "; }
        .icon-location::before { content: "üìç "; }
        .icon-document::before { content: "üìÑ "; }
        .icon-emergency::before { content: "üÜò "; }
        .icon-shield::before { content: "üõ°Ô∏è "; }
        
        /* üìè IMPROVED SPACING & WHITESPACE */
        .section-spacing {
            margin-bottom: 48px;
        }
        
        .content-group {
            margin-bottom: 32px;
        }
        
        .item-spacing {
            margin-bottom: 16px;
        }
        
        .divider {
            height: 1px;
            background: linear-gradient(to right, transparent, #dee2e6, transparent);
            margin: 32px 0;
        }
        
        /* üé¥ ACCORDION LAYOUT FOR SECONDARY FEATURES */
        .accordion {
            background: white;
            border-radius: 12px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            overflow: hidden;
        }
        
        .accordion-header {
            padding: 20px 24px;
            background: linear-gradient(to right, #f8f9fa, white);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            font-size: 1.1em;
            color: #2c3e50;
            transition: all 0.3s ease;
            border-bottom: 1px solid #e8ecef;
        }
        
        .accordion-header:hover {
            background: linear-gradient(to right, #e9ecef, #f8f9fa);
        }
        
        .accordion-header .icon {
            font-size: 1.4em;
            margin-right: 12px;
        }
        
        .accordion-header .arrow {
            transition: transform 0.3s ease;
            font-size: 1.2em;
            color: #6c757d;
        }
        
        .accordion-header.active .arrow {
            transform: rotate(180deg);
        }
        
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, padding 0.4s ease;
            padding: 0 24px;
        }
        
        .accordion-content.active {
            max-height: 2000px;
            padding: 24px;
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 16px;
            padding: 48px 24px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #f8f9ff, #ffffff);
        }
        
        .upload-area:hover {
            background: linear-gradient(135deg, #e6f3ff, #f8f9ff);
            border-color: #5a67d8;
            transform: scale(1.02);
        }
        
        .upload-area.dragover {
            background: linear-gradient(135deg, #d4e4ff, #e6f3ff);
            border-color: #4c51bf;
            box-shadow: 0 0 24px rgba(102, 126, 234, 0.3);
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 10px;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 8px 4px;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 1em;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #5a6268);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #ff9800);
            color: #212529;
        }
        
        .btn-info {
            background: linear-gradient(135deg, #17a2b8, #138496);
        }
        
        /* Enhanced Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes progressBar {
            from { width: 0%; }
            to { width: 85%; }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        /* Toggle Switch for Location Sharing */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255,255,255,0.3);
            transition: .4s;
            border: 2px solid white;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
        }
        
        input:checked + .slider {
            background-color: #4ade80;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .slider.round {
            border-radius: 34px;
        }
        
        .slider.round:before {
            border-radius: 50%;
        }
        
        /* Dark Theme Styles */
        body.dark-theme {
            background: #1a1a2e;
            color: #eee;
        }
        
        body.dark-theme .dashboard-card {
            background: #16213e;
            color: #eee;
            border-color: #0f3460;
        }
        
        body.dark-theme .file-item {
            background: #0f3460;
            border-color: #16213e;
            color: #eee;
        }
        
        /* Tooltip Styles */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85em;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        .file-list {
            margin-top: 15px;
        }
        
        .file-item {
            display: flex;
            justify-content: between;
            align-items: center;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            margin: 5px 0;
            background: #f8f9fa;
        }
        
        .file-info {
            flex-grow: 1;
        }
        
        .file-actions {
            display: flex;
            gap: 5px;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .status-pending {
            background: #ffeaa7;
            color: #d63031;
        }
        
        .status-approved {
            background: #d1f2eb;
            color: #00b894;
        }
        
        .status-rejected {
            background: #ffcccc;
            color: #d63031;
        }
        
        .user-info-card {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
        }
        
        .user-info-card .card-title {
            color: white;
        }
        
        .logout-btn {
            background: #dc3545;
            margin-top: 10px;
        }
        
        .logout-btn:hover {
            background: #c82333;
        }

        /* ========================================
           üöÄ NEW UX IMPROVEMENTS - Phase 2
           ======================================== */

        /* üîç GLOBAL SEARCH BAR */
        .global-search-container {
            position: relative;
            max-width: 600px;
            margin: 0 auto 30px;
        }

        .global-search {
            width: 100%;
            padding: 16px 50px 16px 20px;
            border: 2px solid #e0e6ed;
            border-radius: 30px;
            font-size: 1.05em;
            background: white;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .global-search:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.2);
        }

        .global-search::placeholder {
            color: #9ca3af;
        }

        .search-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.3em;
            color: #9ca3af;
            pointer-events: none;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            margin-top: 8px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }

        .search-results.active {
            display: block;
        }

        .search-result-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f0f3f5;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .search-result-item:hover {
            background: #f8f9fa;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        /* üìä CIRCULAR PROGRESS INDICATOR */
        .circular-progress-container {
            position: relative;
            width: 180px;
            height: 180px;
            margin: 20px auto;
        }

        .circular-progress {
            transform: rotate(-90deg);
        }

        .progress-bg {
            fill: none;
            stroke: #e9ecef;
            stroke-width: 12;
        }

        .progress-bar {
            fill: none;
            stroke: url(#progressGradient);
            stroke-width: 12;
            stroke-linecap: round;
            stroke-dasharray: 440;
            stroke-dashoffset: 440;
            transition: stroke-dashoffset 1s ease;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .progress-percentage {
            font-size: 2.5em;
            font-weight: 700;
            color: #667eea;
            line-height: 1;
        }

        .progress-label {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 5px;
        }

        /* üíÄ SKELETON LOADER */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 8px;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-header {
            height: 24px;
            width: 60%;
            margin-bottom: 12px;
        }

        .skeleton-text {
            height: 16px;
            width: 100%;
            margin-bottom: 8px;
        }

        .skeleton-text:last-child {
            width: 80%;
        }

        .skeleton-card {
            height: 120px;
            margin-bottom: 16px;
        }

        /* üìÅ DOCUMENT FILTERS & SEARCH */
        .document-filters {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e0e6ed;
            border-radius: 8px;
            font-size: 0.95em;
            transition: border-color 0.3s ease;
        }

        .filter-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .filter-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .filter-tag {
            padding: 6px 14px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 20px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-tag:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .filter-tag.active {
            background: linear-gradient(135deg, #4ade80, #22c55e);
        }

        .filter-tag .remove {
            margin-left: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        /* üì§ BULK UPLOAD WITH PREVIEWS */
        .upload-preview-container {
            margin-top: 20px;
            display: none;
        }

        .upload-preview-container.active {
            display: block;
        }

        .upload-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .upload-preview-item {
            position: relative;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 10px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .upload-preview-item:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .upload-preview-icon {
            font-size: 3em;
            margin-bottom: 8px;
        }

        .upload-preview-name {
            font-size: 0.85em;
            color: #495057;
            word-break: break-word;
            margin-bottom: 8px;
        }

        .upload-preview-size {
            font-size: 0.75em;
            color: #9ca3af;
        }

        .upload-preview-progress {
            margin-top: 8px;
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            overflow: hidden;
        }

        .upload-preview-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }

        .upload-preview-remove {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
            transition: all 0.3s ease;
        }

        .upload-preview-remove:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        /* ‚ö†Ô∏è DOCUMENT EXPIRY ALERTS */
        .expiry-banner {
            background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
            color: #2d3436;
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 12px rgba(253, 203, 110, 0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .expiry-banner-icon {
            font-size: 2em;
        }

        .expiry-banner-content {
            flex: 1;
        }

        .expiry-banner-title {
            font-weight: 700;
            font-size: 1.1em;
            margin-bottom: 4px;
        }

        .expiry-banner-message {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .expiry-banner-action {
            background: white;
            color: #2d3436;
            padding: 8px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .expiry-banner-action:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        /* üé† TESTIMONIALS CAROUSEL */
        .testimonials-carousel {
            position: relative;
            overflow: hidden;
            border-radius: 16px;
            background: linear-gradient(135deg, #f8f9fa, white);
            padding: 30px;
        }

        .testimonial-track {
            display: flex;
            transition: transform 0.5s ease;
        }

        .testimonial-item {
            min-width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 20px;
        }

        .testimonial-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 15px;
            border: 4px solid #667eea;
            object-fit: cover;
        }

        .testimonial-text {
            font-size: 1.1em;
            font-style: italic;
            color: #495057;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .testimonial-author {
            font-weight: 700;
            color: #2c3e50;
            font-size: 1.05em;
        }

        .testimonial-role {
            color: #6c757d;
            font-size: 0.9em;
        }

        .carousel-dots {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 20px;
        }

        .carousel-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #dee2e6;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .carousel-dot.active {
            background: #667eea;
            width: 30px;
            border-radius: 5px;
        }

        /* üèÜ ACHIEVEMENT POPUP */
        .achievement-popup {
            position: fixed;
            top: -200px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #2d3436;
            padding: 20px 30px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(255, 215, 0, 0.5);
            z-index: 10000;
            transition: top 0.5s ease;
            text-align: center;
            min-width: 300px;
        }

        .achievement-popup.show {
            top: 30px;
        }

        .achievement-popup-icon {
            font-size: 3em;
            margin-bottom: 10px;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .achievement-popup-title {
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .achievement-popup-message {
            font-size: 0.95em;
        }

        /* üë• CUSTOM TRUSTED CONTACTS */
        .contact-card {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

        .contact-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .contact-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #667eea;
        }

        .contact-info {
            flex: 1;
        }

        .contact-name {
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 3px;
        }

        .contact-relationship {
            font-size: 0.85em;
            color: #6c757d;
            background: #e9ecef;
            padding: 2px 10px;
            border-radius: 12px;
            display: inline-block;
        }

        .contact-actions {
            display: flex;
            gap: 8px;
        }

        .contact-action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .contact-action-btn.primary {
            background: #667eea;
            color: white;
        }

        .contact-action-btn.danger {
            background: #dc3545;
            color: white;
        }

        .contact-action-btn:hover {
            transform: scale(1.05);
        }

        /* üó∫Ô∏è INTERACTIVE MAP CONTAINER */
        .map-container {
            height: 400px;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            margin: 20px 0;
        }

        /* üé® THEME PALETTE SELECTOR */
        .theme-palette-selector {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin: 15px 0;
        }

        .theme-palette {
            width: 80px;
            height: 80px;
            border-radius: 12px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .theme-palette:hover {
            transform: scale(1.05);
            border-color: #2c3e50;
        }

        .theme-palette.active {
            border-color: #667eea;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
        }

        .theme-palette-color {
            flex: 1;
        }

        /* üì± RESPONSIVE IMPROVEMENTS */
        @media (max-width: 768px) {
            .circular-progress-container {
                width: 140px;
                height: 140px;
            }

            .progress-percentage {
                font-size: 2em;
            }

            .global-search-container {
                max-width: 100%;
            }

            .document-filters {
                flex-direction: column;
            }

            .filter-group {
                width: 100%;
            }

            .upload-preview-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
        }

        /* ========================================
           üó∫Ô∏è INTERACTIVE SAFETY MAP WIDGET
           ======================================== */

        .safety-map-widget {
            background: white;
            border-radius: 20px;
            padding: 0;
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
            overflow: hidden;
            margin-bottom: 40px;
            border: 3px solid #4ade80;
        }

        .safety-map-header {
            background: linear-gradient(135deg, #4ade80, #22c55e);
            color: white;
            padding: 24px 28px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .safety-map-title {
            font-size: 1.8em;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .live-badge {
            background: #dc3545;
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.5em;
            font-weight: 700;
            animation: pulse 2s infinite;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .map-toggle-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s ease;
        }

        .map-toggle-btn:hover {
            background: white;
            color: #4ade80;
        }

        .map-container {
            height: 500px;
            position: relative;
            background: #f0f9ff;
        }

        .map-container.disabled {
            filter: grayscale(1);
            opacity: 0.5;
        }

        .map-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.95);
            padding: 40px;
            border-radius: 16px;
            text-align: center;
            z-index: 1000;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
        }

        .map-quick-actions {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .map-action-btn {
            background: white;
            border: none;
            padding: 12px 18px;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-weight: 600;
            font-size: 0.95em;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .map-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        .map-action-btn.primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .map-action-btn.danger {
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
            color: white;
        }

        .map-action-btn.success {
            background: linear-gradient(135deg, #4ade80, #22c55e);
            color: white;
        }

        .map-legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            font-size: 0.9em;
        }

        .legend-title {
            font-weight: 700;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .map-stats-bar {
            background: linear-gradient(to right, #f8f9fa, white);
            padding: 20px 28px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            border-top: 2px solid #e9ecef;
        }

        .map-stat {
            text-align: center;
        }

        .map-stat-value {
            font-size: 2em;
            font-weight: 800;
            color: #4ade80;
        }

        .map-stat-label {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 4px;
        }

        .journey-breadcrumb {
            position: absolute;
            top: 80px;
            left: 20px;
            background: white;
            padding: 12px 16px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            font-size: 0.9em;
            max-width: 250px;
        }

        .breadcrumb-title {
            font-weight: 700;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .breadcrumb-item {
            padding: 6px 0;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .breadcrumb-item:last-child {
            border-bottom: none;
        }

        .breadcrumb-time {
            font-size: 0.85em;
            color: #9ca3af;
        }

        /* Custom Leaflet Popup Styles */
        .custom-popup {
            font-family: system-ui, -apple-system, sans-serif;
        }

        .custom-popup .leaflet-popup-content-wrapper {
            border-radius: 12px;
            padding: 0;
            overflow: hidden;
        }

        .custom-popup .leaflet-popup-content {
            margin: 0;
            padding: 16px;
        }

        .popup-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 16px;
            margin: -16px -16px 12px -16px;
            font-weight: 700;
        }

        .popup-body {
            font-size: 0.9em;
            line-height: 1.6;
        }

        .popup-action {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e9ecef;
        }

        /* Geofence Alert Animation */
        .geofence-alert {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
            color: white;
            padding: 24px 32px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(255, 107, 107, 0.5);
            z-index: 10000;
            animation: slideInDown 0.5s ease;
            text-align: center;
        }

        @keyframes slideInDown {
            from {
                transform: translate(-50%, -150%);
                opacity: 0;
            }
            to {
                transform: translate(-50%, -50%);
                opacity: 1;
            }
        }

        .alert-icon {
            font-size: 3em;
            margin-bottom: 12px;
            animation: shake 0.5s infinite;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Mobile Responsive Map */
        @media (max-width: 768px) {
            .map-container {
                height: 350px;
            }

            .map-quick-actions {
                top: 10px;
                right: 10px;
            }

            .map-action-btn {
                padding: 10px 14px;
                font-size: 0.85em;
            }

            .journey-breadcrumb {
                top: 10px;
                left: 10px;
                max-width: 180px;
                font-size: 0.8em;
            }

            .map-legend {
                bottom: 10px;
                left: 10px;
                font-size: 0.8em;
            }

            .map-stats-bar {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* ========================================
           üö® RISK ALERTS LOG STYLES
           ======================================== */

        .alert-filter-btn {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            color: #6c757d;
            transition: all 0.3s ease;
        }

        .alert-filter-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
        }

        .alert-filter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .alert-item {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 5px solid;
            display: flex;
            align-items: start;
            gap: 16px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .alert-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
            transition: left 0.5s;
        }

        .alert-item:hover::before {
            left: 100%;
        }

        .alert-item:hover {
            transform: translateX(8px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.1);
        }

        .alert-item.critical {
            border-left-color: #dc3545;
            background: #fff5f5;
        }

        .alert-item.warning {
            border-left-color: #ffc107;
            background: #fffbf0;
        }

        .alert-item.info {
            border-left-color: #17a2b8;
            background: #f0f9ff;
        }

        .alert-icon-wrapper {
            font-size: 2.5em;
            flex-shrink: 0;
        }

        .alert-icon-wrapper.flashing {
            animation: flash 1s infinite;
        }

        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .alert-content {
            flex: 1;
        }

        .alert-type {
            font-weight: 700;
            font-size: 1.1em;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .alert-timestamp {
            font-size: 0.85em;
            color: #9ca3af;
            margin-bottom: 8px;
        }

        .alert-location {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 8px;
        }

        .alert-action {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 600;
            border: none;
            cursor: pointer;
            margin-top: 8px;
            transition: all 0.3s ease;
        }

        .alert-action:hover {
            background: #5568d3;
            transform: scale(1.05);
        }

        .alert-dismiss {
            position: absolute;
            top: 12px;
            right: 12px;
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s ease;
        }

        .alert-dismiss:hover {
            color: #dc3545;
            transform: rotate(90deg);
        }

        /* ========================================
           üö∂ JOURNEY HISTORY STYLES
           ======================================== */

        .date-picker {
            padding: 8px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
            color: #2c3e50;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .date-picker:hover {
            border-color: #667eea;
        }

        .date-picker:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .journey-stat-card {
            background: linear-gradient(135deg, #f8f9fa, white);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .journey-stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            border-color: #667eea;
        }

        .journey-stat-icon {
            font-size: 2.5em;
            margin-bottom: 8px;
        }

        .journey-stat-value {
            font-size: 2em;
            font-weight: 800;
            color: #667eea;
            margin-bottom: 4px;
        }

        .journey-stat-label {
            font-size: 0.85em;
            color: #6c757d;
            font-weight: 600;
        }

        .timeline-item {
            display: flex;
            gap: 20px;
            margin-bottom: 24px;
            position: relative;
            padding-left: 40px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: 19px;
            top: 40px;
            bottom: -24px;
            width: 2px;
            background: linear-gradient(to bottom, #667eea, #e9ecef);
        }

        .timeline-item:last-child::before {
            display: none;
        }

        .timeline-marker {
            position: absolute;
            left: 0;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            background: white;
            border: 3px solid;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .timeline-marker.safe {
            border-color: #4ade80;
            background: #f0fdf4;
        }

        .timeline-marker.moderate {
            border-color: #fbbf24;
            background: #fffbeb;
        }

        .timeline-marker.risky {
            border-color: #ef4444;
            background: #fef2f2;
        }

        .timeline-content {
            flex: 1;
            background: white;
            border-radius: 12px;
            padding: 16px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .timeline-content:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateX(4px);
        }

        .timeline-time {
            font-weight: 700;
            color: #667eea;
            margin-bottom: 4px;
        }

        .timeline-location {
            font-size: 1.1em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .timeline-details {
            font-size: 0.9em;
            color: #6c757d;
        }

        .timeline-view-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
            transition: all 0.3s ease;
        }

        .timeline-view-btn:hover {
            background: #5568d3;
            transform: scale(1.05);
        }

        /* ========================================
           üë• TRUSTED CONTACTS STYLES
           ======================================== */

        .contacts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .contact-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            border: 2px solid #e9ecef;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .contact-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .contact-card:hover::before {
            transform: scaleX(1);
        }

        .contact-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 28px rgba(0,0,0,0.15);
            border-color: #667eea;
        }

        .contact-avatar {
            position: relative;
            width: 80px;
            height: 80px;
        }

        .contact-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #e9ecef;
        }

        .contact-status {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 3px solid white;
        }

        .contact-status.online {
            background: #4ade80;
            animation: pulse 2s infinite;
        }

        .contact-status.offline {
            background: #9ca3af;
        }

        .contact-status.nearby {
            background: #fbbf24;
            animation: pulse 2s infinite;
        }

        .contact-info {
            text-align: center;
            width: 100%;
        }

        .contact-name {
            font-size: 1.3em;
            font-weight: 800;
            color: #2c3e50;
            margin-bottom: 4px;
        }

        .contact-relationship {
            font-size: 0.9em;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .contact-distance {
            font-size: 0.85em;
            color: #9ca3af;
        }

        .contact-actions {
            display: flex;
            gap: 8px;
            width: 100%;
            justify-content: center;
        }

        .contact-action-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 2px solid #e9ecef;
            background: white;
            font-size: 1.2em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .contact-action-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .contact-action-btn.call:hover {
            background: #4ade80;
            border-color: #4ade80;
        }

        .contact-action-btn.message:hover {
            background: #667eea;
            border-color: #667eea;
        }

        .contact-action-btn.share:hover {
            background: #fbbf24;
            border-color: #fbbf24;
        }

        .contact-action-btn.map:hover {
            background: #3b82f6;
            border-color: #3b82f6;
        }

        .contact-action-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .contact-action-btn:disabled:hover {
            transform: none;
            box-shadow: none;
            background: white;
        }

        /* Mobile Responsive for New Panels */
        @media (max-width: 768px) {
            .contacts-grid {
                grid-template-columns: 1fr;
            }

            .alert-filter-btn {
                padding: 6px 12px;
                font-size: 0.8em;
            }

            .journey-stat-card {
                padding: 16px;
            }

            .timeline-item {
                padding-left: 30px;
            }

            .timeline-marker {
                width: 30px;
                height: 30px;
                font-size: 1.2em;
            }
        }
    </style>
</head>
<body>
    <!-- üö® STICKY EMERGENCY ACTION BAR -->
    <div id="stickyEmergencyBar" style="position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #dc3545, #c82333); color: white; padding: 12px 20px; z-index: 9999; box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4); display: flex; justify-content: space-between; align-items: center; transform: translateY(-100%); transition: transform 0.3s ease;">
        <div style="font-weight: 700; font-size: 1.1em;">
            <span style="font-size: 1.5em;">üÜò</span> Emergency Quick Access
        </div>
        <div style="display: flex; gap: 12px;">
            <button onclick="triggerEmergency()" class="btn" style="background: #fff; color: #dc3545; font-weight: 700; padding: 10px 20px; margin: 0; box-shadow: none;">
                üö® SOS
            </button>
            <button onclick="triggerPanicAlert()" class="btn" style="background: rgba(255,255,255,0.3); color: white; font-weight: 700; padding: 10px 20px; margin: 0; box-shadow: none; border: 2px solid white;">
                ‚ö†Ô∏è Panic
            </button>
            <button onclick="document.getElementById('stickyEmergencyBar').style.transform = 'translateY(-100%)'" style="background: none; border: none; color: white; font-size: 1.5em; cursor: pointer; padding: 0 10px;">‚úñ</button>
        </div>
    </div>
    
    <!-- üéØ FLOATING EMERGENCY BUTTON -->
    <div id="floatingEmergencyBtn" style="position: fixed; bottom: 30px; right: 30px; z-index: 9998;">
        <button onclick="showEmergencyMenu()" style="width: 70px; height: 70px; border-radius: 50%; background: linear-gradient(135deg, #dc3545, #c82333); color: white; border: none; font-size: 2em; cursor: pointer; box-shadow: 0 8px 24px rgba(220, 53, 69, 0.5); transition: all 0.3s ease; animation: pulse 2s infinite;">
            üÜò
        </button>
        <div id="emergencyMenu" style="display: none; position: absolute; bottom: 80px; right: 0; background: white; border-radius: 16px; padding: 16px; box-shadow: 0 8px 24px rgba(0,0,0,0.2); min-width: 200px;">
            <button onclick="triggerEmergency(); hideEmergencyMenu();" class="btn btn-danger" style="width: 100%; margin-bottom: 8px; justify-content: flex-start;">
                üö® Emergency SOS
            </button>
            <button onclick="triggerPanicAlert(); hideEmergencyMenu();" class="btn btn-warning" style="width: 100%; margin-bottom: 8px; justify-content: flex-start;">
                ‚ö†Ô∏è Panic Alert
            </button>
            <button onclick="enableAIMonitoring(); hideEmergencyMenu();" class="btn btn-info" style="width: 100%; justify-content: flex-start;">
                üìç Share Location
            </button>
        </div>
    </div>
    
    <div class="user-dashboard">
        <!-- üéØ HERO SECTION - Most Important Action -->
        <div id="heroSection" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 48px 40px; border-radius: 20px; margin-bottom: 40px; box-shadow: 0 12px 40px rgba(102, 126, 234, 0.35); position: relative; overflow: hidden;">
            <!-- Background Pattern -->
            <div style="position: absolute; top: 0; right: 0; opacity: 0.1; font-size: 15em; line-height: 0.8;">üõ°Ô∏è</div>
            
            <div style="position: relative; z-index: 1;">
                <h1 style="margin: 0 0 16px 0; font-size: 3em; font-weight: 800; animation: fadeInDown 0.8s;">
                    üëã Welcome, {{ user.full_name or user.username }}!
                </h1>
                <p style="margin: 0 0 32px 0; font-size: 1.3em; opacity: 0.95; animation: fadeIn 1s;">
                    Your safety is our priority. Complete your profile to unlock all protection features.
                </p>
                
                <!-- Progress with Milestones -->
                <div style="background: rgba(255,255,255,0.15); padding: 24px; border-radius: 16px; backdrop-filter: blur(10px); margin-bottom: 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <span style="font-weight: 700; font-size: 1.2em;">Profile Completion</span>
                        <span style="font-weight: 800; font-size: 1.8em;">85%</span>
                    </div>
                    
                    <!-- Milestone Progress Bar -->
                    <div style="position: relative; background: rgba(255,255,255,0.3); height: 20px; border-radius: 10px; overflow: visible; margin: 20px 0;">
                        <div style="background: linear-gradient(90deg, #4ade80, #22c55e); height: 100%; width: 85%; border-radius: 10px; transition: width 1s ease; position: relative; box-shadow: 0 0 20px rgba(74, 222, 128, 0.5);">
                            <div style="position: absolute; right: -10px; top: -5px; width: 30px; height: 30px; background: white; border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 1.2em;">‚úì</div>
                        </div>
                        <!-- Milestone Markers -->
                        <div style="position: absolute; top: -35px; left: 0; width: 100%; display: flex; justify-content: space-between; font-size: 0.85em; font-weight: 600;">
                            <div style="text-align: center;">
                                <div style="margin-bottom: 8px;">‚úì</div>
                                <div>0%</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="margin-bottom: 8px;">‚úì</div>
                                <div>25%</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="margin-bottom: 8px;">‚úì</div>
                                <div>50%</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="margin-bottom: 8px;">‚úì</div>
                                <div>75%</div>
                            </div>
                            <div style="text-align: center; opacity: 0.5;">
                                <div style="margin-bottom: 8px;">üèÜ</div>
                                <div>100%</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="font-size: 1.05em; opacity: 0.95; margin-top: 16px;">
                        <strong>Next Step:</strong> Upload 2 more documents to reach 100% and unlock the Safety Champion badge! üèÖ
                    </div>
                </div>
                
                <!-- Call to Action -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                    <button onclick="document.getElementById('tab-documents').scrollIntoView({behavior: 'smooth'}); switchTab(event, 'documents')" class="btn" style="background: #fff; color: #667eea; font-weight: 700; font-size: 1.15em; padding: 18px; margin: 0;">
                        üìÑ Upload Documents
                    </button>
                    <button onclick="document.getElementById('tab-location').scrollIntoView({behavior: 'smooth'}); switchTab(event, 'location')" class="btn" style="background: rgba(255,255,255,0.25); color: white; font-weight: 700; font-size: 1.15em; padding: 18px; margin: 0; border: 2px solid white;">
                        üìç Enable Safety Tracking
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Enhanced Personalized Header -->
        <div class="dashboard-header" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); border-radius: 20px; box-shadow: 0 10px 30px rgba(17, 153, 142, 0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                <div>
                    <h2 style="margin: 0; font-size: 1.8em; font-weight: 700;">
                        üõ°Ô∏è Your Safety Dashboard
                    </h2>
                    <p style="margin: 10px 0 0 0; font-size: 1.05em; opacity: 0.95;">
                        Last updated: <span id="lastUpdated">Just now</span>
                    </p>
                </div>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <button onclick="document.getElementById('stickyEmergencyBar').style.transform = 'translateY(0)'" class="btn" style="background: rgba(255,255,255,0.25); border: 2px solid white; backdrop-filter: blur(10px); font-size: 1em; padding: 12px 20px; margin: 0;">
                        üö® Emergency Access
                    </button>
                    <button onclick="toggleTheme()" class="btn" style="background: rgba(255,255,255,0.25); border: 2px solid white; backdrop-filter: blur(10px); font-size: 1em; padding: 12px 20px; margin: 0;">
                        üåì Theme
                    </button>
                </div>
            </div>
            
            <!-- Quick Stats Bar with Enhanced Gamification -->
            <div style="margin-top: 25px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 12px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); transition: all 0.3s ease; cursor: pointer;" onclick="switchTab(event, 'documents')">
                    <div style="font-size: 0.9em; opacity: 0.9;">üìÑ Documents Uploaded</div>
                    <div style="font-size: 1.8em; font-weight: bold; margin: 5px 0;">3/5</div>
                    <div style="background: rgba(255,255,255,0.3); height: 8px; border-radius: 4px; overflow: hidden;">
                        <div style="background: #4ade80; height: 100%; width: 60%; animation: progressBar 1.5s ease;"></div>
                    </div>
                    <div style="font-size: 0.85em; opacity: 0.85; margin-top: 5px;">2 more to go! üéØ</div>
                </div>
                
                <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 12px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); position: relative; overflow: hidden;">
                    <div style="font-size: 0.9em; opacity: 0.9;">üõ°Ô∏è Safety Score</div>
                    <div style="font-size: 1.8em; font-weight: bold; margin: 5px 0;">92</div>
                    <div style="font-size: 0.85em; opacity: 0.85;">
                        Excellent! 
                        <button onclick="showSafetyBreakdown()" style="background: none; border: none; color: white; text-decoration: underline; cursor: pointer; padding: 0; margin-left: 5px;">Details</button>
                    </div>
                    <!-- Mini chart indicator -->
                    <div style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font-size: 3em; opacity: 0.2;">üìä</div>
                </div>
                
                <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 12px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2);">
                    <div style="font-size: 0.9em; opacity: 0.9;">üìç Location Status</div>
                    <div style="font-size: 1.8em; font-weight: bold; margin: 5px 0;">
                        <span id="headerLocationStatus">OFF</span>
                    </div>
                    <div style="font-size: 0.85em; opacity: 0.85;">
                        <label class="switch" style="transform: scale(0.8);">
                            <input type="checkbox" id="headerLocationToggle" onchange="toggleLocationSharing(this.checked)">
                            <span class="slider round"></span>
                        </label>
                        <span style="margin-left: 8px;">Enable now</span>
                    </div>
                </div>
                
                <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 12px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); cursor: pointer;" onclick="showBadgeShowcase()">
                    <div style="font-size: 0.9em; opacity: 0.9;">üèÜ Badges Earned</div>
                    <div style="font-size: 1.8em; font-weight: bold; margin: 5px 0; display: flex; gap: 5px; align-items: center;">
                        <span>ü•á</span><span>ü•à</span><span>ü•â</span><span>‚≠ê</span>
                    </div>
                    <div style="font-size: 0.85em; opacity: 0.85;">4 achievements üéâ</div>
                </div>
            </div>
        </div>
        
        <!-- üéñÔ∏è BADGE SHOWCASE MODAL -->
        <div id="badgeShowcaseModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center; animation: fadeIn 0.3s;">
            <div style="background: white; border-radius: 20px; padding: 40px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; position: relative;">
                <button onclick="document.getElementById('badgeShowcaseModal').style.display='none'" style="position: absolute; top: 20px; right: 20px; background: none; border: none; font-size: 2em; cursor: pointer; color: #6c757d;">‚úñ</button>
                
                <h2 style="margin: 0 0 24px 0; color: #667eea; font-size: 2em;">üèÜ Your Achievements</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 20px;">
                    <!-- Earned Badges -->
                    <div class="tooltip" style="background: linear-gradient(135deg, #ffd700, #ffed4e); padding: 20px; border-radius: 16px; text-align: center; box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);">
                        <div style="font-size: 4em;">ü•á</div>
                        <div style="font-weight: 700; color: #2c3e50; margin-top: 8px;">Early Adopter</div>
                        <span class="tooltiptext">Joined within first month!</span>
                    </div>
                    
                    <div class="tooltip" style="background: linear-gradient(135deg, #c0c0c0, #e8e8e8); padding: 20px; border-radius: 16px; text-align: center; box-shadow: 0 4px 12px rgba(192, 192, 192, 0.3);">
                        <div style="font-size: 4em;">ü•à</div>
                        <div style="font-weight: 700; color: #2c3e50; margin-top: 8px;">Document Master</div>
                        <span class="tooltiptext">Uploaded 3+ documents</span>
                    </div>
                    
                    <div class="tooltip" style="background: linear-gradient(135deg, #cd7f32, #e9c9a7); padding: 20px; border-radius: 16px; text-align: center; box-shadow: 0 4px 12px rgba(205, 127, 50, 0.3);">
                        <div style="font-size: 4em;">ü•â</div>
                        <div style="font-weight: 700; color: #2c3e50; margin-top: 8px;">Safety First</div>
                        <span class="tooltiptext">Enabled AI monitoring</span>
                    </div>
                    
                    <div class="tooltip" style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 20px; border-radius: 16px; text-align: center; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);">
                        <div style="font-size: 4em;">‚≠ê</div>
                        <div style="font-weight: 700; color: white; margin-top: 8px;">Verified User</div>
                        <span class="tooltiptext">Email verified!</span>
                    </div>
                    
                    <!-- Locked Badges -->
                    <div class="tooltip" style="background: #f8f9fa; padding: 20px; border-radius: 16px; text-align: center; border: 2px dashed #dee2e6; opacity: 0.6;">
                        <div style="font-size: 4em;">üîí</div>
                        <div style="font-weight: 700; color: #6c757d; margin-top: 8px;">Safety Champion</div>
                        <span class="tooltiptext">Complete profile to 100%</span>
                    </div>
                    
                    <div class="tooltip" style="background: #f8f9fa; padding: 20px; border-radius: 16px; text-align: center; border: 2px dashed #dee2e6; opacity: 0.6;">
                        <div style="font-size: 4em;">üîí</div>
                        <div style="font-weight: 700; color: #6c757d; margin-top: 8px;">Globe Trotter</div>
                        <span class="tooltiptext">Visit 5 countries</span>
                    </div>
                </div>
                
                <div style="margin-top: 32px; padding: 20px; background: #f8f9fa; border-radius: 12px; text-align: center;">
                    <div style="font-size: 1.2em; font-weight: 700; color: #667eea; margin-bottom: 8px;">üéØ Next Milestone</div>
                    <p style="margin: 0; color: #6c757d;">Upload 2 more documents to unlock the Safety Champion badge!</p>
                </div>
            </div>
        </div>
        
        <!-- üìä SAFETY SCORE BREAKDOWN MODAL -->
        <div id="safetyBreakdownModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center; animation: fadeIn 0.3s;">
            <div style="background: white; border-radius: 20px; padding: 40px; max-width: 500px; width: 90%; position: relative;">
                <button onclick="document.getElementById('safetyBreakdownModal').style.display='none'" style="position: absolute; top: 20px; right: 20px; background: none; border: none; font-size: 2em; cursor: pointer; color: #6c757d;">‚úñ</button>
                
                <h2 style="margin: 0 0 24px 0; color: #667eea; font-size: 2em;">üõ°Ô∏è Safety Score: 92/100</h2>
                
                <div style="margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-weight: 600;">üìÑ Profile Completeness</span>
                        <span style="font-weight: 700; color: #28a745;">+40</span>
                    </div>
                    <div style="background: #e9ecef; height: 10px; border-radius: 5px; overflow: hidden;">
                        <div style="background: #28a745; height: 100%; width: 80%;"></div>
                    </div>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-weight: 600;">üìç Location Sharing</span>
                        <span style="font-weight: 700; color: #dc3545;">+0</span>
                    </div>
                    <div style="background: #e9ecef; height: 10px; border-radius: 5px; overflow: hidden;">
                        <div style="background: #dc3545; height: 100%; width: 0%;"></div>
                    </div>
                    <small style="color: #6c757d;">Enable to earn +30 points</small>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-weight: 600;">‚úÖ Email Verified</span>
                        <span style="font-weight: 700; color: #28a745;">+20</span>
                    </div>
                    <div style="background: #e9ecef; height: 10px; border-radius: 5px; overflow: hidden;">
                        <div style="background: #28a745; height: 100%; width: 100%;"></div>
                    </div>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-weight: 600;">ü§ñ AI Monitoring</span>
                        <span style="font-weight: 700; color: #28a745;">+17</span>
                    </div>
                    <div style="background: #e9ecef; height: 10px; border-radius: 5px; overflow: hidden;">
                        <div style="background: #28a745; height: 100%; width: 85%;"></div>
                    </div>
                </div>
                
                <div style="margin-top: 24px; padding: 16px; background: #e7f3ff; border-radius: 12px; border-left: 4px solid #667eea;">
                    <strong style="color: #667eea;">üí° Tip:</strong> Enable location sharing to reach 100/100 score!
                </div>
            </div>
        </div>
        
        <!-- üîç GLOBAL SEARCH BAR -->
        <div class="global-search-container">
            <input type="text" 
                   class="global-search" 
                   id="globalSearch" 
                   placeholder="üîç Search documents, actions, help..." 
                   oninput="performGlobalSearch(this.value)">
            <span class="search-icon">üîç</span>
            <div id="searchResults" class="search-results"></div>
        </div>
        
        <!-- Priority Features: SOS, Documents, Location at Top -->
        
        <!-- Priority Features: SOS, Documents, Location at Top -->
        <div class="dashboard-grid">
            <!-- üÜò PRIORITY 1: Emergency SOS (ENHANCED) -->
            <div class="dashboard-card" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color: white; border: 3px solid #ff4757;">
                <div class="card-title" style="color: white; border-bottom-color: rgba(255,255,255,0.3);">
                    <span class="card-icon" style="font-size: 2.5em;">üÜò</span>
                    <span data-translate="emergency_sos">Emergency SOS</span>
                </div>
                <p style="margin: 15px 0; font-size: 1.05em;">
                    <strong>One-tap emergency assistance.</strong> Your location and details will be sent to authorities and emergency contacts immediately.
                </p>
                <button class="btn" id="emergencyBtn" onclick="confirmEmergency()" style="background: #fff; color: #ff6b6b; font-weight: 800; font-size: 1.4em; padding: 24px; width: 100%; border: 3px solid #fff; box-shadow: 0 8px 24px rgba(255, 107, 107, 0.4); animation: pulse 2s infinite;">
                    üö® EMERGENCY SOS üö®
                </button>
                <div style="margin-top: 16px; padding: 12px; background: rgba(255,255,255,0.2); border-radius: 10px; font-size: 0.9em; border-left: 4px solid white;">
                    <strong>‚ö†Ô∏è Important:</strong> Only use in real emergencies. False alarms may result in penalties.
                </div>
                <div style="margin-top: 12px; font-size: 0.85em; opacity: 0.9;">
                    ‚úÖ Works offline  ‚Ä¢  üåç Global coverage  ‚Ä¢  ‚ö° Instant response
                </div>
            </div>

            <!-- üìÑ PRIORITY 2: Document Upload (ENHANCED) -->
            <div class="dashboard-card" style="border: 3px solid #00b894; position: relative; overflow: hidden;">
                <div class="card-title">
                    <span class="card-icon" style="font-size: 2em;">üìÑ</span>
                    <span data-translate="upload_docs" style="color: #00b894;">Document Manager</span>
                </div>
                
                <!-- Drag & Drop Zone with Visual Feedback -->
                <div class="upload-area" id="uploadAreaPriority" 
                     ondragover="handleDragOver(event)" 
                     ondragleave="handleDragLeave(event)" 
                     ondrop="handleDrop(event)"
                     onclick="document.getElementById('fileInput').click()" 
                     style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-color: #00b894; border-width: 3px; position: relative;">
                    
                    <div id="dropFeedback" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 184, 148, 0.2); border: 4px dashed #00b894; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 2em; font-weight: 700; color: #00b894; z-index: 10;">
                        üìÅ Drop files here!
                    </div>
                    
                    <div style="font-size: 3.5em; margin-bottom: 16px; animation: bounce 2s infinite;">üìÅ</div>
                    <p style="font-size: 1.3em; font-weight: bold; color: #00b894; margin-bottom: 12px;">
                        Drag & drop files here or click to browse
                    </p>
                    <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin-bottom: 12px;">
                        <span class="status-badge status-safe">PDF</span>
                        <span class="status-badge status-safe">JPG</span>
                        <span class="status-badge status-safe">PNG</span>
                    </div>
                    <p style="font-size: 0.9em; color: #666; margin: 8px 0;">
                        üìè Max 5MB per file  ‚Ä¢  üîí Encrypted  ‚Ä¢  ‚õìÔ∏è Blockchain verified
                    </p>
                </div>
                
                <!-- Upload Progress -->
                <div id="uploadProgress" style="display: none; margin: 16px 0; padding: 16px; background: #f8f9fa; border-radius: 12px;">
                    <div style="margin-bottom: 8px; font-weight: 600;">Uploading...</div>
                    <div style="background: #dee2e6; height: 12px; border-radius: 6px; overflow: hidden;">
                        <div id="progressBar" style="background: linear-gradient(90deg, #00b894, #55efc4); height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <div style="margin-top: 8px; font-size: 0.9em; color: #6c757d;">
                        <span id="uploadStatus">0%</span> - <span id="uploadFileName">filename.pdf</span>
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="uploadFiles()" style="width: 100%; font-size: 1.2em; padding: 16px; margin-top: 16px;">
                    <span>üì§</span> <span>Upload Selected Files</span>
                </button>
                
                <!-- Documents Completion Progress -->
                <div style="margin-top: 20px; padding: 16px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 12px; border-left: 4px solid #00b894;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="font-weight: 700; color: #2c3e50;">Documents: 3/5</span>
                        <span style="font-weight: 800; color: #00b894; font-size: 1.3em;">60%</span>
                    </div>
                    <div style="background: #dee2e6; height: 12px; border-radius: 6px; overflow: hidden; position: relative;">
                        <div style="background: linear-gradient(90deg, #00b894, #55efc4); height: 100%; width: 60%; transition: width 0.8s ease; position: relative;">
                            <div style="position: absolute; right: -6px; top: -3px; width: 18px; height: 18px; background: white; border: 3px solid #00b894; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.2);"></div>
                        </div>
                    </div>
                    <p style="margin-top: 10px; font-size: 0.95em; color: #495057;">
                        üéØ Upload <strong>Visa</strong> and <strong>Travel Insurance</strong> to complete!
                    </p>
                </div>
            </div>

            <!-- üìç PRIORITY 3: Location & Safety -->
            <div class="dashboard-card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border: 3px solid #0fb89d;">
                <div class="card-title" style="color: white; border-bottom-color: rgba(255,255,255,0.3);">
                    <span class="card-icon" style="font-size: 2.5em;">üìç</span>
                    <span data-translate="location_tracking">Live Location & AI Safety</span>
                </div>
                
                <!-- Location Status -->
                <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 12px; margin: 16px 0; border: 2px solid rgba(255,255,255,0.3);">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <div id="locationIconPriority" style="font-size: 3em; animation: pulse 2s infinite;">üìç</div>
                            <div>
                                <div style="font-weight: 700; font-size: 1.3em;">
                                    <span id="locationStatusPriority" class="status-badge status-warning">Inactive</span>
                                </div>
                                <div style="font-size: 0.95em; opacity: 0.95; margin-top: 6px;">
                                    <span id="currentLocationPriority">Enable to share location</span>
                                </div>
                            </div>
                        </div>
                        <label class="switch" title="Toggle location sharing" style="transform: scale(1.2);">
                            <input type="checkbox" id="locationTogglePriority" onchange="toggleLocationSharing(this.checked)">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
                
                <!-- Safety Features -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 16px 0;">
                    <div style="background: rgba(255,255,255,0.25); padding: 16px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 2.5em; margin-bottom: 8px;">üõ°Ô∏è</div>
                        <div style="font-size: 0.9em; font-weight: 600;">Safe Zones</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.25); padding: 16px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 2.5em; margin-bottom: 8px;">‚ö†Ô∏è</div>
                        <div style="font-size: 0.9em; font-weight: 600;">Risk Alerts</div>
                    </div>
                </div>
                
                <button onclick="enableAIMonitoring()" class="btn" style="background: #fff; color: #11998e; font-weight: 700; font-size: 1.2em; padding: 18px; width: 100%; margin: 0; box-shadow: 0 4px 16px rgba(255,255,255,0.3);">
                    <span>üöÄ</span> <span>Enable AI Safety Monitoring</span>
                </button>
                
                <div style="margin-top: 16px; font-size: 0.85em; opacity: 0.95; text-align: center;">
                    ‚úì Real-time tracking  ‚Ä¢  ‚úì Auto alerts  ‚Ä¢  ‚úì Share with family
                </div>
            </div>
        </div>
        
        <!-- Smart Notification Center -->
        <div class="dashboard-card" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; margin-bottom: 32px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div class="card-title" style="color: white; margin: 0; border: none;">
                    <span class="card-icon" style="font-size: 2em;">üîî</span>
                    <span>Action Recommendations</span>
                </div>
                <button onclick="dismissNotifications()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 16px; border-radius: 8px; cursor: pointer;">
                    Dismiss All
                </button>
            </div>
            
            <div id="notificationsList" style="margin-top: 20px;">
                <!-- Dynamic notifications will be added here -->
                <div class="notification-item" style="background: rgba(255,255,255,0.15); padding: 16px; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid #ffc107;">
                    <div style="display: flex; align-items: start; gap: 12px;">
                        <span style="font-size: 2em;">‚ö†Ô∏è</span>
                        <div style="flex: 1;">
                            <div style="font-weight: 700; font-size: 1.1em; margin-bottom: 6px;">Complete Your Profile</div>
                            <div style="opacity: 0.95; margin-bottom: 10px;">Upload 2 more documents to reach 100% completion and unlock Safety Champion badge!</div>
                            <button onclick="switchTab(event, 'documents')" class="btn" style="background: white; color: #667eea; padding: 8px 16px; margin: 0; font-size: 0.9em;">
                                Upload Now ‚Üí
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="notification-item" style="background: rgba(255,255,255,0.15); padding: 16px; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid #17a2b8;">
                    <div style="display: flex; align-items: start; gap: 12px;">
                        <span style="font-size: 2em;">üí°</span>
                        <div style="flex: 1;">
                            <div style="font-weight: 700; font-size: 1.1em; margin-bottom: 6px;">Safety Tip</div>
                            <div style="opacity: 0.95;">Enable location sharing for real-time safety monitoring and instant emergency response.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- üó∫Ô∏è INTERACTIVE SAFETY MAP WIDGET -->
        <div class="safety-map-widget">
            <div class="safety-map-header">
                <div class="safety-map-title">
                    üó∫Ô∏è Safety Map
                    <span class="live-badge" id="mapLiveBadge">
                        <span class="live-dot"></span> LIVE
                    </span>
                </div>
                <button class="map-toggle-btn" id="mapToggleBtn" onclick="toggleSafetyMap()">
                    Enable AI Tracking
                </button>
            </div>
            
            <div class="map-container" id="safetyMapContainer">
                <!-- Map Overlay for Disabled State -->
                <div class="map-overlay" id="mapOverlay">
                    <div style="font-size: 3em; margin-bottom: 12px;">üó∫Ô∏è</div>
                    <h3 style="margin: 0 0 12px 0; color: #2c3e50;">Safety Map Disabled</h3>
                    <p style="color: #6c757d; margin-bottom: 20px;">Enable AI monitoring to activate real-time location tracking</p>
                    <button onclick="toggleSafetyMap()" class="btn" style="background: linear-gradient(135deg, #4ade80, #22c55e); color: white; border: none; padding: 12px 24px; font-weight: 700;">
                        üöÄ Enable Now
                    </button>
                </div>
                
                <!-- Leaflet Map -->
                <div id="safetyMap" style="width: 100%; height: 100%;"></div>
                
                <!-- Quick Action Buttons -->
                <div class="map-quick-actions" id="mapQuickActions" style="display: none;">
                    <button class="map-action-btn success" onclick="shareLocation()">
                        üìç Share Location
                    </button>
                    <button class="map-action-btn primary" onclick="viewEmergencyContacts()">
                        üë• Contacts
                    </button>
                    <button class="map-action-btn danger" onclick="triggerEmergency()">
                        üö® Emergency
                    </button>
                    <button class="map-action-btn" onclick="findNearbyServices()">
                        üè• Services
                    </button>
                </div>
                
                <!-- Journey Breadcrumb -->
                <div class="journey-breadcrumb" id="journeyBreadcrumb" style="display: none;">
                    <div class="breadcrumb-title">üö∂ Recent Journey</div>
                    <div id="breadcrumbList">
                        <!-- Dynamic breadcrumbs will be added here -->
                    </div>
                </div>
                
                <!-- Safety Zone Legend -->
                <div class="map-legend" id="mapLegend" style="display: none;">
                    <div class="legend-title">üõ°Ô∏è Safety Zones</div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: rgba(74, 222, 128, 0.4); border: 2px solid #4ade80;"></div>
                        <span>Safe Zone</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: rgba(251, 191, 36, 0.4); border: 2px solid #fbbf24;"></div>
                        <span>Moderate Zone</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: rgba(239, 68, 68, 0.4); border: 2px solid #ef4444;"></div>
                        <span>Restricted Zone</span>
                    </div>
                </div>
            </div>
            
            <!-- Map Statistics Bar -->
            <div class="map-stats-bar" id="mapStatsBar" style="display: none;">
                <div class="map-stat">
                    <div class="map-stat-value" id="currentZone">Safe</div>
                    <div class="map-stat-label">Current Zone</div>
                </div>
                <div class="map-stat">
                    <div class="map-stat-value" id="distanceTraveled">0 km</div>
                    <div class="map-stat-label">Distance Today</div>
                </div>
                <div class="map-stat">
                    <div class="map-stat-value" id="locationsTracked">0</div>
                    <div class="map-stat-label">Locations Tracked</div>
                </div>
                <div class="map-stat">
                    <div class="map-stat-value" id="safetyAlerts">0</div>
                    <div class="map-stat-label">Safety Alerts</div>
                </div>
            </div>
        </div>
        
        <!-- üö® REAL-TIME RISK ALERTS LOG -->
        <div class="dashboard-card" id="riskAlertsPanel" style="display: none; background: white; border-radius: 20px; padding: 28px; box-shadow: 0 8px 32px rgba(0,0,0,0.12); margin-bottom: 32px; border-left: 6px solid #ff6b6b;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div class="card-title" style="margin: 0; border: none;">
                    <span class="card-icon" style="font-size: 2em; animation: pulse 2s infinite;">üö®</span>
                    <span style="font-size: 1.5em; font-weight: 800; color: #2c3e50;">Recent Safety Alerts</span>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="filterAlerts('all')" class="alert-filter-btn active" data-filter="all">
                        All (<span id="alertCountAll">0</span>)
                    </button>
                    <button onclick="filterAlerts('critical')" class="alert-filter-btn" data-filter="critical">
                        Critical (<span id="alertCountCritical">0</span>)
                    </button>
                    <button onclick="filterAlerts('warning')" class="alert-filter-btn" data-filter="warning">
                        Warning (<span id="alertCountWarning">0</span>)
                    </button>
                    <button onclick="clearAllAlerts()" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        Clear All
                    </button>
                </div>
            </div>
            
            <div id="alertsList" style="max-height: 400px; overflow-y: auto;">
                <div class="empty-state" style="text-align: center; padding: 60px 20px; color: #9ca3af;">
                    <div style="font-size: 4em; margin-bottom: 16px;">‚úÖ</div>
                    <h3 style="color: #6c757d; margin: 0 0 8px 0;">No Active Alerts</h3>
                    <p style="margin: 0;">You're in a safe zone. Alerts will appear here when you enter risky areas.</p>
                </div>
            </div>
        </div>
        
        <!-- üö∂ JOURNEY HISTORY PANEL -->
        <div class="dashboard-card" id="journeyHistoryPanel" style="display: none; background: white; border-radius: 20px; padding: 28px; box-shadow: 0 8px 32px rgba(0,0,0,0.12); margin-bottom: 32px; border-left: 6px solid #667eea;">
            <!-- REMOVED: Journey History feature not needed for user dashboard -->
        </div>
        
        <!-- üë• TRUSTED CONTACTS PANEL -->
        <div class="dashboard-card" id="trustedContactsPanel" style="display: none; background: white; border-radius: 20px; padding: 28px; box-shadow: 0 8px 32px rgba(0,0,0,0.12); margin-bottom: 32px; border-left: 6px solid #4ade80;">
            <!-- REMOVED: Trusted Contacts feature completely removed -->
        </div>
        
        <!-- Quick Tips Banner -->
        <div class="dashboard-card" style="background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%); color: #2d3436; margin: 20px 0; animation: slideInRight 0.8s;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <span style="font-size: 3em;">üí°</span>
                <div>
                    <strong style="font-size: 1.2em;">Quick Tip:</strong>
                    <p style="margin: 5px 0 0 0;">Complete your profile and upload all documents to unlock the "Safety Champion" badge! üèÖ</p>
                </div>
                <button onclick="this.parentElement.parentElement.style.display='none'" style="background: none; border: none; font-size: 1.5em; cursor: pointer;">‚úñÔ∏è</button>
            </div>
        </div>
        
        <div class="dashboard-grid">
            <!-- User Information Card -->
            <div class="dashboard-card user-info-card">
                <div class="card-title">
                    <span class="card-icon">üë§</span>
                    <span data-translate="user_info">User Information</span>
                </div>
                <div class="user-details">
                    <p><strong>Username:</strong> {{ user.username }}</p>
                    <p><strong>Full Name:</strong> {{ user.full_name }}</p>
                    <p><strong>Email:</strong> {{ user.email }}</p>
                    <p><strong>Email Verified:</strong> 
                        {% if user.email_verified %}
                            <span class="status-badge status-approved">‚úì Verified</span>
                        {% else %}
                            <span class="status-badge status-pending">‚ö† Not Verified</span>
                        {% endif %}
                    </p>
                </div>
                <a href="/logout" class="btn logout-btn" onclick="return confirm('Are you sure you want to logout?')">Logout</a>
            </div>
            
            <!-- Digital ID Card -->
            <div class="dashboard-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <div class="card-title" style="color: white;">
                    <span class="card-icon">ü™™</span>
                    <span data-translate="digital_id">Digital ID Card</span>
                </div>
                <p style="margin: 15px 0;">Access your official digital identification card with blockchain verification.</p>
                <div style="text-align: center; margin: 20px 0;">
                    <i class="fas fa-id-card" style="font-size: 4em; opacity: 0.8;"></i>
                </div>
                <a href="/digital-id?tourist_id={{ user.user_id }}" class="btn" style="background: #fff; color: #667eea; font-weight: bold; width: 100%; text-align: center; text-decoration: none; display: block; padding: 15px;">
                    üìá View Digital ID Card
                </a>
                <p style="margin-top: 15px; font-size: 0.9em; opacity: 0.9;">
                    <strong>Features:</strong> QR Code, Blockchain Verified
                </p>
            </div>
            
            <!-- Emergency SOS Card -->
            <div class="dashboard-card" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color: white;">
                <div class="card-title" style="color: white;">
                    <span class="card-icon">üÜò</span>
                    <span data-translate="emergency_sos">Emergency SOS</span>
                </div>
                <p style="margin: 15px 0;">Press this button in case of emergency. Your location and details will be sent to authorities immediately.</p>
                <button class="btn" id="emergencyBtn" onclick="triggerEmergency()" style="background: #fff; color: #ff6b6b; font-weight: bold; font-size: 1.2em; padding: 20px; width: 100%; border: 3px solid #fff;">
                    üö® EMERGENCY SOS üö®
                </button>
                <p style="margin-top: 15px; font-size: 0.9em; opacity: 0.9;">
                    <strong>Note:</strong> Only use in real emergencies. False alarms may result in penalties.
                </p>
            </div>

            <!-- Panic Alert Card -->
            <div class="dashboard-card" style="background: linear-gradient(135deg, #ffa502 0%, #ff6348 100%); color: white;">
                <div class="card-title" style="color: white;">
                    <span class="card-icon">‚ö†Ô∏è</span>
                    <span data-translate="panic_alert">Panic Alert</span>
                </div>
                <p style="margin: 15px 0;">Send a quick panic alert if you feel unsafe or threatened. This alert is less severe than SOS.</p>
                <button class="btn" id="panicBtn" onclick="triggerPanicAlert()" style="background: #fff; color: #ff6348; font-weight: bold; font-size: 1.1em; padding: 15px; width: 100%; border: 3px solid #fff;">
                    ‚ö†Ô∏è PANIC ALERT ‚ö†Ô∏è
                </button>
                <p style="margin-top: 15px; font-size: 0.9em; opacity: 0.9;">
                    Use this if you feel unsafe but don't require immediate emergency response.
                </p>
            </div>
            
            <!-- Enhanced Document Upload Card with Tooltips -->
            <div class="dashboard-card" style="border: 3px solid #00b894; animation: fadeIn 1s;">
                <div class="card-title">
                    <span class="card-icon" style="font-size: 2em;">ÔøΩ</span>
                    <span data-translate="upload_docs" style="color: #00b894;">Upload Your Documents</span>
                    <div class="tooltip" style="margin-left: auto;">
                        <span style="cursor: help; font-size: 1.2em;">‚ÑπÔ∏è</span>
                        <span class="tooltiptext">Upload passport, visa, ID cards, and travel documents here. All files are encrypted and blockchain-verified for maximum security!</span>
                    </div>
                </div>
                
                <!-- Activity Feed -->
                <div style="background: #f0f9ff; padding: 12px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #3498db;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.5em;">üìã</span>
                        <div style="color: #2c3e50;">
                            <strong>Recent Activity:</strong><br>
                            <small>You haven't uploaded any documents yet. Add your first document now to get started! üöÄ</small>
                        </div>
                    </div>
                </div>
                
                <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-color: #00b894; border-width: 3px;">
                    <div style="font-size: 3em; margin-bottom: 10px; animation: bounce 2s infinite;">üìÅ</div>
                    <p style="font-size: 1.2em; font-weight: bold; color: #00b894;">Click here or drag & drop files to upload</p>
                    <p style="font-size: 0.95em; color: #555; margin-top: 10px;">
                        ‚úÖ Supported: PDF, JPG, PNG<br>
                        üìè Max Size: 5MB per file<br>
                        üîí 100% Secure & Encrypted
                    </p>
                    <label for="fileInput" style="display: none;">Upload document files</label>
                    <input type="file" id="fileInput" multiple accept=".pdf,.jpg,.jpeg,.png" style="display: none;" aria-label="Upload document files" title="Upload document files (PDF, JPG, PNG)">
                </div>
                <button class="btn btn-success" onclick="uploadFiles()" style="width: 100%; font-size: 1.2em; padding: 15px; margin-top: 15px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span>üì§</span> <span>Upload Selected Files</span>
                </button>
                
                <!-- Progress Indicator -->
                <div style="margin-top: 15px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-weight: bold;">Documents Completion:</span>
                        <span style="font-weight: bold; color: #00b894;">60%</span>
                    </div>
                    <div style="background: #dee2e6; height: 10px; border-radius: 5px; overflow: hidden;">
                        <div style="background: linear-gradient(90deg, #00b894, #55efc4); height: 100%; width: 60%; transition: width 0.5s;"></div>
                    </div>
                    <p style="margin-top: 8px; font-size: 0.9em; color: #666;">
                        3 of 5 documents uploaded. Upload 2 more to complete your profile! üéØ
                    </p>
                </div>
            </div>
            
            <!-- Recent Documents -->
            <div class="dashboard-card">
                <div class="card-title">
                    <span class="card-icon">üìÑ</span>
                    <span data-translate="recent_docs">Recent Documents</span>
                </div>
                <div class="file-list" id="documentList">
                    <!-- Documents will be loaded dynamically from backend -->
                    <p style="color: #999; padding: 15px; text-align: center;">Loading documents...</p>
                </div>
                <button class="btn" onclick="loadAllDocuments()">üîÑ Refresh Documents</button>
            </div>
            
            <!-- AI Safety Monitoring with Google Maps-like Features -->
            <div class="dashboard-card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; grid-column: span 2;">
                <div class="card-title" style="color: white;">
                    <span class="card-icon">üó∫Ô∏è</span>
                    <span data-translate="ai_monitoring">AI Safety Monitoring & Live Location</span>
                </div>
                <p style="margin: 15px 0; font-size: 1.05em;">
                    üìç Enable real-time AI Safety Monitoring to securely track your location and help ensure your safety. Share your live location with trusted contacts, receive instant alerts if you enter risky zones, and get help quickly in emergencies‚Äîall while keeping your data private.
                </p>
                
                <!-- Location Sharing Status -->
                <div id="locationSharingStatus" style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 12px; margin: 15px 0; border: 2px solid rgba(255,255,255,0.3);">
                    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div id="locationStatusIcon" style="font-size: 2.5em; animation: pulse 2s infinite;">üìç</div>
                            <div>
                                <div style="font-weight: bold; font-size: 1.2em;">Location Sharing: <span id="locationStatusText">Inactive</span></div>
                                <div style="font-size: 0.9em; opacity: 0.9; margin-top: 5px;">
                                    <span id="currentLocationText">Enable monitoring to share your location</span>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="switch" title="Toggle location sharing">
                                <input type="checkbox" id="locationToggle" onchange="toggleLocationSharing(this.checked)">
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Features Grid -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin: 15px 0;">
                    <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2em;">üõ°Ô∏è</div>
                        <div style="font-size: 0.9em; margin-top: 5px;">Safe Zones</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2em;">üë•</div>
                        <div style="font-size: 0.9em; margin-top: 5px;">Trusted Contacts</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2em;">‚ö†Ô∏è</div>
                        <div style="font-size: 0.9em; margin-top: 5px;">Risk Alerts</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2em;">üìä</div>
                        <div style="font-size: 0.9em; margin-top: 5px;">Journey History</div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px;">
                    <button onclick="enableAIMonitoring()" class="btn" style="background: #fff; color: #11998e; font-weight: bold; font-size: 1.1em; padding: 15px; border: none; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <span>üöÄ</span> <span>Start Monitoring</span>
                    </button>
                    <button onclick="viewSafetyMap()" class="btn" style="background: rgba(255,255,255,0.2); color: white; font-weight: bold; font-size: 1.1em; padding: 15px; border: 2px solid white; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <span>üó∫Ô∏è</span> <span>View Safety Map</span>
                    </button>
                </div>
                
                <div style="margin-top: 15px; padding: 12px; background: rgba(255,255,255,0.1); border-radius: 8px; font-size: 0.9em;">
                    <strong>üí° How it works:</strong> Our AI Safety Monitoring uses smart algorithms to track your journey in real time, just like Google Maps. Easily share your current location with friends or family, set safety zones, and receive notifications if unexpected situations arise.
                </div>
            </div>
                <p style="margin: 15px 0;">Real-time AI analysis of your location and behavior patterns for enhanced safety.</p>
                <div id="aiMonitoringStatus" style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 5px; margin: 10px 0;">
                    <strong>Status:</strong> <span id="aiStatusText">Disabled</span><br>
                    <strong>Risk Level:</strong> <span id="aiRiskLevel" style="font-weight: bold; font-size: 16px;">---</span>
                </div>
                <button class="btn" onclick="toggleAIMonitoring()" id="aiMonitorBtn" style="background: #fff; color: #667eea; font-weight: bold;">
                    Enable AI Monitoring
                </button>
            </div>

            <!-- Geofencing & Zone Alerts -->
            <div class="dashboard-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                <div class="card-title" style="color: white;">
                    <span class="card-icon">üìç</span>
                    <span data-translate="geofencing">Geofencing & Safe Zones</span>
                </div>
                <p style="margin: 15px 0;">Track your location and get alerts when entering restricted or unsafe zones.</p>
                <div id="geofenceStatus" style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 5px; margin: 10px 0;">
                    <strong>Current Zone:</strong> <span id="currentZone">Unknown</span><br>
                    <strong>Violations:</strong> <span id="violationCount">0</span>
                </div>
                <button class="btn" onclick="checkGeofence()" style="background: #fff; color: #f5576c; font-weight: bold;">
                    Check Current Location
                </button>
            </div>

            <!-- Auto SOS Detection -->
            <div class="dashboard-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white;">
                <div class="card-title" style="color: white;">
                    <span class="card-icon">üö®</span>
                    <span data-translate="auto_sos">Auto SOS Detection</span>
                </div>
                <p style="margin: 15px 0;">Automatic emergency detection based on unusual patterns or lack of activity.</p>
                <div id="autoSosStatus" style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 5px; margin: 10px 0;">
                    <strong>Status:</strong> <span id="autoSosStatusText">Disabled</span><br>
                    <strong>Last Check:</strong> <span id="autoSosLastCheck">Never</span>
                </div>
                <button class="btn" onclick="toggleAutoSOS()" id="autoSosBtn" style="background: #fff; color: #fa709a; font-weight: bold;">
                    Enable Auto SOS
                </button>
            </div>

            <!-- Quick Actions -->
            <div class="dashboard-card">
                <div class="card-title">
                    <span class="card-icon">‚ö°</span>
                    <span data-translate="quick_actions">Quick Actions</span>
                </div>
                <div class="actions-grid">
                    <button class="btn" onclick="window.location.href='/enhanced_registration'" style="font-size: 1.05em; padding: 12px;">üìù Update Profile</button>
                    <button class="btn btn-secondary" onclick="downloadProfile()" style="font-size: 1.05em; padding: 12px;">üì• Download Profile</button>
                    <button class="btn btn-success" onclick="verifyEmail()" style="font-size: 1.05em; padding: 12px;">‚úÖ Verify Email</button>
                    <button class="btn" onclick="window.location.href='/digital-id'" style="font-size: 1.05em; padding: 12px;">ü™™ View Digital ID</button>
                </div>
            </div>
        </div>
        
        <!-- üéØ TABBED INTERFACE FOR BETTER ORGANIZATION -->
        <div class="tabs-container section-spacing">
            <div class="tabs-header">
                <button class="tab-button active" onclick="switchTab(event, 'overview')">
                    <span class="tab-icon">üìä</span>
                    <span>Overview</span>
                </button>
                <button class="tab-button" onclick="switchTab(event, 'documents')">
                    <span class="tab-icon">üìÑ</span>
                    <span>Documents</span>
                </button>
                <button class="tab-button" onclick="switchTab(event, 'location')">
                    <span class="tab-icon">üìç</span>
                    <span>Location & Safety</span>
                </button>
                <button class="tab-button" onclick="switchTab(event, 'settings')">
                    <span class="tab-icon">‚öôÔ∏è</span>
                    <span>Settings</span>
                </button>
            </div>
            
            <!-- OVERVIEW TAB -->
            <div id="tab-overview" class="tab-content active">
                <div class="content-group">
                    <h3 style="color: #667eea; margin-bottom: 20px; display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 1.5em;">üìä</span> Dashboard Overview
                    </h3>
                    <p style="color: #6c757d; font-size: 1.05em; line-height: 1.6; margin-bottom: 32px;">
                        Welcome to your safety dashboard! Here you can manage your documents, track your location, and access emergency features.
                    </p>
                </div>
                
                <!-- Quick Stats with improved spacing -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 24px; margin-bottom: 32px;">
                    <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 24px; border-radius: 16px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);">
                        <div style="font-size: 0.95em; opacity: 0.95; margin-bottom: 8px;">üìÑ Documents</div>
                        <div style="font-size: 2.5em; font-weight: bold; margin: 8px 0;">3/5</div>
                        <div style="font-size: 0.9em; opacity: 0.9;">Upload 2 more to complete</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 24px; border-radius: 16px; box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);">
                        <div style="font-size: 0.95em; opacity: 0.95; margin-bottom: 8px;">üõ°Ô∏è Safety Score</div>
                        <div style="font-size: 2.5em; font-weight: bold; margin: 8px 0;">92</div>
                        <div style="font-size: 0.9em; opacity: 0.9;">Excellent protection</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 24px; border-radius: 16px; box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);" id="riskLevelCard">
                        <div style="font-size: 0.95em; opacity: 0.95; margin-bottom: 8px;">‚ö†Ô∏è Risk Level</div>
                        <div style="font-size: 2.5em; font-weight: bold; margin: 8px 0;"><span id="riskLevelBadge">LOW</span></div>
                        <div style="font-size: 0.9em; opacity: 0.9;" id="riskLevelText">Safe conditions</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #17a2b8, #138496); color: white; padding: 24px; border-radius: 16px; box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);">
                        <div style="font-size: 0.95em; opacity: 0.95; margin-bottom: 8px;">üìç Location Status</div>
                        <div style="font-size: 2.5em; font-weight: bold; margin: 8px 0;"><span id="overviewLocationStatus">OFF</span></div>
                        <div style="font-size: 0.9em; opacity: 0.9;">Enable tracking</div>
                    </div>
                </div>
                
                <div class="divider"></div>
                
                <!-- Recent Activity -->
                <div class="content-group">
                    <h4 style="color: #2c3e50; margin-bottom: 16px; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.3em;">üìã</span> Recent Activity
                    </h4>
                    <div id="recentActivityContainer" style="background: #f8f9fa; padding: 20px; border-radius: 12px; border-left: 4px solid #667eea;">
                        <p style="color: #6c757d; margin: 0;">
                            <span class="icon-info"></span> Loading recent activity...
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- DOCUMENTS TAB -->
            <div id="tab-documents" class="tab-content">
                <div class="content-group">
                    <h3 style="color: #667eea; margin-bottom: 20px; display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 1.5em;">üìÑ</span> Document Management
                    </h3>
                    <p style="color: #6c757d; font-size: 1.05em; line-height: 1.6; margin-bottom: 32px;">
                        Upload, manage, and verify your travel documents. All files are encrypted and blockchain-verified for maximum security.
                    </p>
                </div>
                
                <!-- Upload Area with improved design -->
                <div class="upload-area" id="uploadAreaTab" onclick="document.getElementById('fileInput').click()">
                    <div style="font-size: 4em; margin-bottom: 20px; animation: bounce 2s infinite;">üìÅ</div>
                    <h4 style="margin: 0 0 16px 0; color: #667eea; font-size: 1.3em;">Click here or drag & drop files to upload</h4>
                    <p style="font-size: 1em; color: #6c757d; margin: 16px 0; line-height: 1.8;">
                        <span class="status-safe" style="padding: 4px 12px; margin: 4px;">PDF</span>
                        <span class="status-safe" style="padding: 4px 12px; margin: 4px;">JPG</span>
                        <span class="status-safe" style="padding: 4px 12px; margin: 4px;">PNG</span><br>
                        <span style="display: inline-block; margin-top: 12px;">üìè Max Size: 5MB per file</span><br>
                        <span>üîí 100% Secure & Encrypted</span>
                    </p>
                </div>
                
                <button class="btn btn-success" onclick="uploadFiles()" style="width: 100%; margin-top: 20px; font-size: 1.1em; padding: 16px;">
                    <span>üì§</span> Upload Selected Files
                </button>
                
                <div class="divider"></div>
                
                <!-- Document List -->
                <div class="content-group">
                    <h4 style="color: #2c3e50; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.3em;">üìö</span> Your Documents
                    </h4>
                    <div class="file-list" id="documentListTab">
                        <p style="color: #999; padding: 24px; text-align: center; background: #f8f9fa; border-radius: 12px; border: 2px dashed #dee2e6;">
                            <span style="font-size: 2em; display: block; margin-bottom: 12px;">üì≠</span>
                            No documents uploaded yet. Upload your first document above!
                        </p>
                    </div>
                    <button class="btn btn-info" onclick="loadAllDocuments()" style="margin-top: 20px;">
                        <span>üîÑ</span> Refresh Documents
                    </button>
                </div>
            </div>
            
            <!-- LOCATION & SAFETY TAB -->
            <div id="tab-location" class="tab-content">
                <div class="content-group">
                    <h3 style="color: #667eea; margin-bottom: 20px; display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 1.5em;">üìç</span> Location & Safety Monitoring
                    </h3>
                    <p style="color: #6c757d; font-size: 1.05em; line-height: 1.6; margin-bottom: 32px;">
                        Enable real-time AI Safety Monitoring to track your location and ensure your safety. Share your live location with trusted contacts.
                    </p>
                </div>
                
                <!-- Location Status Card -->
                <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 32px; border-radius: 16px; margin-bottom: 32px; box-shadow: 0 8px 24px rgba(17, 153, 142, 0.3);">
                    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 20px; margin-bottom: 24px;">
                        <div style="display: flex; align-items: center; gap: 20px;">
                            <div id="locationStatusIconTab" style="font-size: 3.5em; animation: pulse 2s infinite;">üìç</div>
                            <div>
                                <div style="font-weight: 700; font-size: 1.5em; margin-bottom: 8px;">
                                    Location Sharing: <span id="locationStatusTextTab" class="status-badge status-warning">Inactive</span>
                                </div>
                                <div style="font-size: 1.05em; opacity: 0.95;">
                                    <span id="currentLocationTextTab">Enable monitoring to share your location</span>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="switch" title="Toggle location sharing">
                                <input type="checkbox" id="locationToggleTab" onchange="toggleLocationSharing(this.checked)">
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Safety Features Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 16px; margin-bottom: 24px;">
                        <div style="background: rgba(255,255,255,0.25); padding: 20px; border-radius: 12px; text-align: center; backdrop-filter: blur(10px);">
                            <div style="font-size: 2.8em; margin-bottom: 8px;">üõ°Ô∏è</div>
                            <div style="font-size: 1em; font-weight: 600;">Safe Zones</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.25); padding: 20px; border-radius: 12px; text-align: center; backdrop-filter: blur(10px);">
                            <div style="font-size: 2.8em; margin-bottom: 8px;">‚ö†Ô∏è</div>
                            <div style="font-size: 1em; font-weight: 600;">Risk Alerts</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.25); padding: 20px; border-radius: 12px; text-align: center; backdrop-filter: blur(10px);">
                            <div style="font-size: 2.8em; margin-bottom: 8px;">üìä</div>
                            <div style="font-size: 1em; font-weight: 600;">Journey History</div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <button onclick="enableAIMonitoring()" class="btn" style="background: #fff; color: #11998e; font-weight: 700; padding: 18px; font-size: 1.05em;">
                            <span>üöÄ</span> Start Monitoring
                        </button>
                        <button onclick="viewSafetyMap()" class="btn" style="background: rgba(255,255,255,0.25); color: white; font-weight: 700; padding: 18px; border: 2px solid white; font-size: 1.05em;">
                            <span>üó∫Ô∏è</span> View Safety Map
                        </button>
                    </div>
                </div>
                
                <!-- AI Monitoring Status -->
                <div class="content-group">
                    <h4 style="color: #2c3e50; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.3em;">ü§ñ</span> Protection Systems Status
                    </h4>
                    <div id="systemStatusContainer" style="background: #f8f9fa; padding: 24px; border-radius: 12px; border-left: 4px solid #667eea;">
                        <div style="margin-bottom: 16px;">
                            <strong style="color: #2c3e50;">ü§ñ AI Monitoring:</strong> <span id="aiMonitoringStatus" class="status-badge status-safe">Active</span>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <strong style="color: #2c3e50;">üõ°Ô∏è Auto SOS Detection:</strong> <span id="autoSosStatus" class="status-badge status-safe">Active</span>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <strong style="color: #2c3e50;">üìç Location Tracking:</strong> <span id="locationStatus" class="status-badge status-warning">Ready</span>
                        </div>
                        <div>
                            <strong style="color: #2c3e50;">üó∫Ô∏è Safety Map:</strong> <span id="safetyMapStatus" class="status-badge status-warning">Ready</span>
                        </div>
                        <div style="margin-top: 16px; padding-top: 16px; border-top: 2px solid #e5e7eb; font-size: 0.9em; color: #6c757d;">
                            ‚ú® All protection systems are operational and monitoring your safety 24/7
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="refreshSystemStatus()" style="margin-top: 20px; font-size: 1.05em; padding: 16px;">
                        <span>üîÑ</span> Refresh Status
                    </button>
                </div>
            </div>
            
            <!-- SETTINGS TAB -->
            <div id="tab-settings" class="tab-content">
                <div class="content-group">
                    <h3 style="color: #667eea; margin-bottom: 20px; display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 1.5em;">‚öôÔ∏è</span> Dashboard Settings
                    </h3>
                    <p style="color: #6c757d; font-size: 1.05em; line-height: 1.6; margin-bottom: 32px;">
                        Customize your dashboard experience and manage your preferences.
                    </p>
                </div>
                
                <!-- Appearance Settings -->
                <div class="accordion item-spacing">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span class="icon" style="font-size: 1.6em;">üé®</span>
                            <span style="font-size: 1.1em; font-weight: 600;">Appearance</span>
                        </div>
                        <span class="arrow">‚ñº</span>
                    </div>
                    <div class="accordion-content">
                        <label style="display: flex; align-items: center; gap: 16px; cursor: pointer; padding: 16px; background: #f8f9fa; border-radius: 12px; transition: all 0.3s ease;">
                            <input type="checkbox" id="darkModeToggle" onchange="toggleTheme()" style="width: 20px; height: 20px; cursor: pointer;">
                            <span style="font-weight: 600; font-size: 1.05em;">üåì Enable Dark Mode</span>
                        </label>
                    </div>
                </div>
                
                <!-- Language Settings -->
                <div class="accordion item-spacing">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span class="icon" style="font-size: 1.6em;">üåê</span>
                            <span style="font-size: 1.1em; font-weight: 600;">Language & Translation</span>
                        </div>
                        <span class="arrow">‚ñº</span>
                    </div>
                    <div class="accordion-content">
                        <label style="display: block; margin-bottom: 12px; font-weight: 600; color: #2c3e50;">Preferred Language:</label>
                        <select style="width: 100%; padding: 14px 16px; border-radius: 10px; border: 2px solid #dee2e6; font-size: 1em; cursor: pointer; background: white;">
                            <option value="en">üá¨üáß English</option>
                            <option value="es">üá™üá∏ Spanish</option>
                            <option value="fr">üá´üá∑ French</option>
                            <option value="de">üá©üá™ German</option>
                            <option value="hi">üáÆüá≥ Hindi</option>
                            <option value="zh">üá®üá≥ Chinese</option>
                        </select>
                    </div>
                </div>
                
                <!-- Notification Settings -->
                <div class="accordion item-spacing">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span class="icon" style="font-size: 1.6em;">üîî</span>
                            <span style="font-size: 1.1em; font-weight: 600;">Notifications</span>
                        </div>
                        <span class="arrow">‚ñº</span>
                    </div>
                    <div class="accordion-content">
                        <label style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px; cursor: pointer; padding: 16px; background: #f8f9fa; border-radius: 12px;">
                            <input type="checkbox" checked style="width: 20px; height: 20px; cursor: pointer;">
                            <span style="font-weight: 600;">üö® Emergency Alerts</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px; cursor: pointer; padding: 16px; background: #f8f9fa; border-radius: 12px;">
                            <input type="checkbox" checked style="width: 20px; height: 20px; cursor: pointer;">
                            <span style="font-weight: 600;">üìç Location Updates</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 16px; cursor: pointer; padding: 16px; background: #f8f9fa; border-radius: 12px;">
                            <input type="checkbox" checked style="width: 20px; height: 20px; cursor: pointer;">
                            <span style="font-weight: 600;">üìÑ Document Status</span>
                        </label>
                    </div>
                </div>
                
                <!-- Privacy Settings -->
                <div class="accordion item-spacing">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span class="icon" style="font-size: 1.6em;">üîí</span>
                            <span style="font-size: 1.1em; font-weight: 600;">Privacy & Security</span>
                        </div>
                        <span class="arrow">‚ñº</span>
                    </div>
                    <div class="accordion-content">
                        <label style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px; padding: 16px; background: #f8f9fa; border-radius: 12px; opacity: 0.7;">
                            <input type="checkbox" checked disabled style="width: 20px; height: 20px;">
                            <span style="font-weight: 600;">üîê Blockchain Verification (Required)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 16px; cursor: pointer; padding: 16px; background: #f8f9fa; border-radius: 12px;">
                            <input type="checkbox" style="width: 20px; height: 20px; cursor: pointer;">
                            <span style="font-weight: 600;">üëÅÔ∏è Allow Anonymous Location Sharing</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- User Testimonials Section -->
        <div class="dashboard-card" style="margin-top: 30px; background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); animation: fadeIn 1.2s;">
            <div style="text-align: center; margin-bottom: 25px;">
                <h2 style="color: #2d3436; font-size: 2em; margin: 0;">‚≠ê What Our Users Say</h2>
                <p style="color: #636e72; font-size: 1.1em; margin-top: 10px;">Real stories from travelers like you!</p>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                    <div style="font-size: 2em; margin-bottom: 10px;">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
                    <p style="color: #2d3436; font-style: italic; margin: 15px 0;">"The SOS feature helped me feel safe when traveling alone in unfamiliar areas! Quick response and super easy to use."</p>
                    <div style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                        <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.2em;">S</div>
                        <div>
                            <strong style="color: #2d3436;">Sarah M.</strong><br>
                            <small style="color: #636e72;">Solo Traveler, USA</small>
                        </div>
                    </div>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                    <div style="font-size: 2em; margin-bottom: 10px;">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
                    <p style="color: #2d3436; font-style: italic; margin: 15px 0;">"AI monitoring is a game-changer! My family always knows where I am, and the risk zone alerts saved me from dangerous areas."</p>
                    <div style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                        <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #11998e, #38ef7d); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.2em;">R</div>
                        <div>
                            <strong style="color: #2d3436;">Raj P.</strong><br>
                            <small style="color: #636e72;">Business Traveler, India</small>
                        </div>
                    </div>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                    <div style="font-size: 2em; margin-bottom: 10px;">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
                    <p style="color: #2d3436; font-style: italic; margin: 15px 0;">"Digital ID with blockchain verification made my immigration process so smooth! No more carrying physical documents everywhere."</p>
                    <div style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                        <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #ff6b6b, #ee5a6f); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.2em;">L</div>
                        <div>
                            <strong style="color: #2d3436;">Lisa K.</strong><br>
                            <small style="color: #636e72;">Tourist, Germany</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Interactive Tutorial -->
        <div class="dashboard-card" style="margin-top: 30px; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); animation: fadeIn 1.4s;">
            <div style="text-align: center;">
                <h2 style="color: #2d3436; font-size: 2em; margin: 0;">üéì New Here? Take a Quick Tour!</h2>
                <p style="color: #636e72; font-size: 1.1em; margin: 15px 0;">Learn how to make the most of your safety dashboard in just 2 minutes</p>
                <button onclick="startTutorial()" class="btn" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; font-size: 1.3em; padding: 18px 40px; margin-top: 15px; border: none; box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);">
                    üöÄ Start Interactive Tour
                </button>
                <div style="margin-top: 20px; display: flex; justify-content: center; gap: 30px; flex-wrap: wrap; color: #2d3436;">
                    <div style="text-align: center;">
                        <div style="font-size: 3em;">üì§</div>
                        <strong>Upload Documents</strong>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 3em;">üÜò</div>
                        <strong>Emergency SOS</strong>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 3em;">üó∫Ô∏è</div>
                        <strong>Location Tracking</strong>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 3em;">ü™™</div>
                        <strong>Digital ID</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Store user information from template
        const currentUser = {
            user_id: '{{ user.user_id }}',
            username: '{{ user.username }}',
            full_name: '{{ user.full_name }}'
        };

        // File upload functionality
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        let selectedFiles = [];

        // Drag and drop functionality
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            handleFileSelection(files);
        });

        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            handleFileSelection(files);
        });

        function handleFileSelection(files) {
            selectedFiles = files;
            updateUploadAreaText();
        }

        function updateUploadAreaText() {
            if (selectedFiles.length > 0) {
                uploadArea.innerHTML = `
                    <p><strong>${selectedFiles.length} file(s) selected:</strong></p>
                    <p>${selectedFiles.map(f => f.name).join(', ')}</p>
                `;
            }
        }

        function uploadFiles() {
            if (selectedFiles.length === 0) {
                alert('Please select files to upload');
                return;
            }

            const formData = new FormData();
            selectedFiles.forEach((file, index) => {
                formData.append(`file_${index}`, file);
            });

            fetch('/api/upload/documents', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Files uploaded successfully!');
                    selectedFiles = [];
                    fileInput.value = '';
                    uploadArea.innerHTML = `
                        <p>Click here or drag & drop files to upload</p>
                        <p style="font-size: 0.9em; color: #666;">Supported: PDF, JPG, PNG (Max 5MB)</p>
                    `;
                    loadAllDocuments();
                } else {
                    alert('Upload failed: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Upload error:', error);
                alert('Upload failed. Please try again.');
            });
        }

        function viewDocument(filename) {
            window.open(`/api/documents/view/${filename}`, '_blank');
        }

        function loadAllDocuments() {
            // Add cache-busting parameter
            const timestamp = new Date().getTime();
            fetch(`/api/user/documents/list?t=${timestamp}`, {
                method: 'GET',
                headers: {
                    'Cache-Control': 'no-cache',
                    'Pragma': 'no-cache'
                },
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    updateDocumentList(data.documents || []);
                } else {
                    console.error('API error:', data.error);
                    const list = document.getElementById('documentList');
                    list.innerHTML = `<p style="color: #dc3545;">Error: ${data.error || 'Unknown error'}</p>`;
                }
            })
            .catch(error => {
                console.error('Error loading documents:', error);
                const list = document.getElementById('documentList');
                list.innerHTML = `<p style="color: #999;">Unable to load documents: ${error.message}</p>`;
            });
        }

        function updateDocumentList(documents) {
            const list = document.getElementById('documentList');
            const listTab = document.getElementById('documentListTab');
            
            if (!documents || documents.length === 0) {
                const emptyState = `
                    <div style="text-align: center; padding: 40px 20px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 16px; border: 2px dashed #dee2e6;">
                        <div style="font-size: 5em; margin-bottom: 16px; opacity: 0.5;">üì≠</div>
                        <h3 style="color: #6c757d; margin: 0 0 12px 0; font-size: 1.3em;">No Documents Yet</h3>
                        <p style="color: #868e96; margin: 0 0 24px 0; font-size: 1em;">
                            Upload your first document to get started with secure document management.
                        </p>
                        <button onclick="document.getElementById('uploadAreaPriority').scrollIntoView({behavior: 'smooth'})" class="btn btn-primary" style="margin: 0;">
                            <span>üì§</span> Upload Your First Document
                        </button>
                    </div>
                `;
                if (list) list.innerHTML = emptyState;
                if (listTab) listTab.innerHTML = emptyState;
                return;
            }

            const documentsHTML = documents.map(doc => {
                const timeAgo = getTimeAgo(doc.uploaded_at);
                const statusClass = doc.verified ? 'safe' : 'warning';
                const statusText = doc.verified ? '‚úì Verified' : '‚è≥ Pending';
                const fileExtension = doc.filename.split('.').pop().toUpperCase();
                
                // Determine document type icon
                let docIcon = 'üìÑ';
                let docType = 'Document';
                if (fileExtension === 'PDF') { docIcon = 'üìï'; docType = 'PDF Document'; }
                else if (['JPG', 'JPEG', 'PNG'].includes(fileExtension)) { docIcon = 'üñºÔ∏è'; docType = 'Image'; }
                
                // Auto-categorize document type
                let category = 'Other';
                const filename = doc.filename.toLowerCase();
                if (filename.includes('passport')) { category = 'Passport'; docIcon = 'üõÇ'; }
                else if (filename.includes('visa')) { category = 'Visa'; docIcon = 'üé´'; }
                else if (filename.includes('id') || filename.includes('identity')) { category = 'ID Card'; docIcon = 'ü™™'; }
                else if (filename.includes('insurance')) { category = 'Insurance'; docIcon = 'üè•'; }
                else if (filename.includes('ticket')) { category = 'Ticket'; docIcon = 'üéüÔ∏è'; }
                
                return `
                <div class="file-item" style="display: flex; align-items: center; padding: 16px; border: 1px solid #dee2e6; border-radius: 12px; margin-bottom: 12px; background: white; transition: all 0.3s ease; cursor: pointer;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'; this.style.transform='translateY(-2px)';" onmouseout="this.style.boxShadow='none'; this.style.transform='translateY(0)';">
                    <!-- Document Thumbnail/Icon -->
                    <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 2em; margin-right: 16px; flex-shrink: 0; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);">
                        ${docIcon}
                    </div>
                    
                    <!-- Document Info -->
                    <div style="flex: 1; min-width: 0;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                            <strong style="font-size: 1.05em; color: #2c3e50; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${doc.filename}</strong>
                            <span class="status-badge status-${statusClass}" style="flex-shrink: 0;">${statusText}</span>
                        </div>
                        <div style="display: flex; gap: 16px; font-size: 0.9em; color: #6c757d;">
                            <span>üìÅ ${category}</span>
                            <span>üìè ${fileExtension}</span>
                            <span>üïí ${timeAgo}</span>
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    <div style="display: flex; gap: 8px; flex-shrink: 0; margin-left: 16px;">
                        <button class="btn btn-info" onclick="viewDocument('${doc.stored_path}')" style="margin: 0; padding: 8px 16px; font-size: 0.9em;">
                            üëÅÔ∏è View
                        </button>
                        <button class="btn btn-secondary" onclick="downloadDocument('${doc.stored_path}', '${doc.filename}')" style="margin: 0; padding: 8px 16px; font-size: 0.9em;">
                            ‚¨áÔ∏è Download
                        </button>
                    </div>
                </div>
                `;
            }).join('');

            if (list) list.innerHTML = documentsHTML;
            if (listTab) listTab.innerHTML = documentsHTML;
        }
        
        function downloadDocument(path, filename) {
            const link = document.createElement('a');
            link.href = `/api/documents/view/${path}`;
            link.download = filename;
            link.click();
            showNotification(`‚¨áÔ∏è Downloading ${filename}...`, 'info');
        }

        function getTimeAgo(dateString) {
            if (!dateString) return 'Recently';
            
            const date = new Date(dateString);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000); // seconds

            if (diff < 60) return 'Just now';
            if (diff < 3600) return `${Math.floor(diff / 60)} minutes ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)} hours ago`;
            if (diff < 604800) return `${Math.floor(diff / 86400)} days ago`;
            
            return date.toLocaleDateString();
        }

        function downloadProfile() {
            window.location.href = '/api/user/profile/download';
        }

        function verifyEmail() {
            fetch('/api/user/send-verification', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Verification email sent! Please check your inbox.');
                } else {
                    alert('Failed to send verification email: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to send verification email.');
            });
        }

        // Emergency SOS function with enhanced confirmation and cancellable countdown
        function triggerEmergency() {
            // Show custom confirmation modal
            const modalHTML = `
                <div id="sosConfirmModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.3s;">
                    <div style="background: white; border-radius: 20px; padding: 40px; max-width: 500px; text-align: center; box-shadow: 0 10px 50px rgba(0,0,0,0.5);">
                        <div style="font-size: 4em; margin-bottom: 20px;">üö®</div>
                        <h2 style="color: #d63031; margin-bottom: 20px; font-size: 2em;">EMERGENCY ALERT</h2>
                        <p style="color: #2d3436; font-size: 1.2em; line-height: 1.6; margin-bottom: 25px;">
                            Are you in <strong>immediate danger</strong>?<br><br>
                            This will:<br>
                            ‚úì Alert local authorities<br>
                            ‚úì Share your live location<br>
                            ‚úì Notify emergency contacts<br>
                            ‚úì Dispatch help immediately
                        </p>
                        <p style="color: #636e72; margin-bottom: 30px; font-weight: bold;">
                            ‚ö†Ô∏è Only use for REAL emergencies
                        </p>
                        <div style="display: flex; gap: 15px; justify-content: center;">
                            <button onclick="cancelEmergencySOS()" style="padding: 15px 40px; font-size: 1.1em; border: 2px solid #636e72; background: white; color: #636e72; border-radius: 12px; cursor: pointer; font-weight: bold;">
                                Cancel
                            </button>
                            <button onclick="confirmEmergencySOS()" style="padding: 15px 40px; font-size: 1.1em; border: none; background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%); color: white; border-radius: 12px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 15px rgba(255, 65, 108, 0.4);">
                                YES - I NEED HELP NOW
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function cancelEmergencySOS() {
            const modal = document.getElementById('sosConfirmModal');
            if (modal) modal.remove();
            
            const countdown = document.getElementById('sosCountdownModal');
            if (countdown) countdown.remove();
            
            showNotification('Emergency SOS cancelled', 'info');
        }

        function confirmEmergencySOS() {
            // Remove confirmation modal
            const modal = document.getElementById('sosConfirmModal');
            if (modal) modal.remove();
            
            // Show countdown modal with CANCEL button
            let countdown = 3;
            const countdownHTML = `
                <div id="sosCountdownModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 10001; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.3s;">
                    <div style="background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%); border-radius: 20px; padding: 50px; text-align: center; box-shadow: 0 10px 50px rgba(0,0,0,0.8);">
                        <h2 style="color: white; margin-bottom: 20px; font-size: 1.8em;">Activating Emergency SOS</h2>
                        <div id="countdownNumber" style="font-size: 8em; color: white; font-weight: bold; margin: 30px 0; animation: pulse 1s infinite;">3</div>
                        <p style="color: white; font-size: 1.2em; margin-bottom: 25px; opacity: 0.9;">Help is being dispatched...</p>
                        <button onclick="cancelEmergencySOS()" style="padding: 15px 50px; font-size: 1.2em; border: 3px solid white; background: rgba(255,255,255,0.2); color: white; border-radius: 12px; cursor: pointer; font-weight: bold; backdrop-filter: blur(10px);">
                            ‚úï CANCEL
                        </button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', countdownHTML);
            
            const countdownInterval = setInterval(() => {
                countdown--;
                const countdownEl = document.getElementById('countdownNumber');
                if (countdownEl) {
                    countdownEl.textContent = countdown;
                }
                
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    const countdownModal = document.getElementById('sosCountdownModal');
                    if (countdownModal) countdownModal.remove();
                    
                    // Actually trigger SOS
                    executeEmergencySOS();
                }
            }, 1000);
        }

        function executeEmergencySOS() {
            const btn = document.getElementById('emergencyBtn');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = 'üö® SOS ACTIVATED';
                btn.style.opacity = '0.6';
            }

            // Get user's current location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        sendEmergencySOS({
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        });
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        // Send SOS without location if geolocation fails
                        sendEmergencySOS(null);
                    }
                );
            } else {
                // Send SOS without location if geolocation not supported
                sendEmergencySOS(null);
            }
        }

        function sendEmergencySOS(location) {
            const payload = {
                tourist_id: currentUser.user_id,
                timestamp: new Date().toISOString(),
                emergency_type: 'manual_sos',
                message: 'Emergency SOS triggered from user dashboard',
                user_agent: navigator.userAgent
            };

            if (location) {
                payload.location = location;
            }

            fetch('/api/emergency/sos', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                const btn = document.getElementById('emergencyBtn');
                btn.disabled = false;
                btn.style.opacity = '1';
                
                if (data.success) {
                    btn.innerHTML = '‚úÖ SOS SENT!';
                    btn.style.background = '#28a745';
                    btn.style.color = 'white';
                    
                    // Store SOS ID for status checking
                    if (data.sos_id) {
                        localStorage.setItem('lastSOSId', data.sos_id);
                    }
                    
                    alert('üö® EMERGENCY SOS SENT SUCCESSFULLY!\n\nSOS ID: ' + data.sos_id + '\n\n‚úÖ Authorities have been notified\n‚úÖ Your location has been shared\n‚úÖ Help is on the way\n\nYou can check response status from your dashboard.\n\nStay calm and stay safe.');
                    
                    // Show check status button
                    showSOSStatusButton(data.sos_id);
                    
                    // Reset button after 5 seconds
                    setTimeout(() => {
                        btn.innerHTML = 'üö® EMERGENCY SOS üö®';
                        btn.style.background = '#fff';
                        btn.style.color = '#ff6b6b';
                    }, 5000);
                } else {
                    btn.innerHTML = 'üö® EMERGENCY SOS üö®';
                    alert('‚ùå Failed to send SOS: ' + (data.error || 'Unknown error') + '\n\nPlease try again or call emergency services directly.');
                }
            })
            .catch(error => {
                console.error('SOS error:', error);
                const btn = document.getElementById('emergencyBtn');
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.innerHTML = 'üö® EMERGENCY SOS üö®';
                alert('‚ùå Failed to send SOS due to network error.\n\nPlease call emergency services directly:\nüìû Emergency Number: 911 or local emergency services');
            });
        }

        function showSOSStatusButton(sosId) {
            // Add a status check button near the SOS button
            const emergencyCard = document.getElementById('emergencyBtn').parentElement;
            let statusBtn = document.getElementById('checkSOSStatusBtn');
            
            if (!statusBtn) {
                statusBtn = document.createElement('button');
                statusBtn.id = 'checkSOSStatusBtn';
                statusBtn.className = 'btn';
                statusBtn.style.cssText = 'background: #17a2b8; color: white; margin-top: 10px; width: 100%;';
                statusBtn.onclick = function() { checkSOSStatus(sosId); };
                emergencyCard.appendChild(statusBtn);
            }
            
            statusBtn.innerHTML = 'üìã Check SOS Status';
            statusBtn.setAttribute('data-sos-id', sosId);
        }

        function checkSOSStatus(sosId) {
            if (!sosId) {
                sosId = localStorage.getItem('lastSOSId');
            }
            
            if (!sosId) {
                alert('No SOS alerts found. Please send an SOS first.');
                return;
            }
            
            console.log('Checking SOS status for:', sosId);
            
            fetch('/api/emergency/sos/status/' + sosId)
                .then(response => {
                    console.log('SOS status response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('SOS status data:', data);
                    
                    if (data.success) {
                        let statusMessage = 'üìã SOS STATUS\n\n';
                        statusMessage += 'SOS ID: ' + data.sos_id + '\n';
                        statusMessage += 'Status: ' + data.status + '\n';
                        statusMessage += 'Created: ' + new Date(data.created_at).toLocaleString() + '\n';
                        
                        if (data.admin_response) {
                            statusMessage += '\n‚úÖ ADMIN RESPONSE:\n';
                            statusMessage += data.admin_response + '\n';
                            if (data.responded_by) {
                                statusMessage += '\nResponded by: ' + data.responded_by;
                            }
                            if (data.updated_at) {
                                statusMessage += '\nResponse time: ' + new Date(data.updated_at).toLocaleString();
                            }
                        } else {
                            statusMessage += '\n‚è≥ Waiting for admin response...';
                        }
                        
                        alert(statusMessage);
                    } else {
                        alert('‚ùå Could not retrieve SOS status: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error checking SOS status:', error);
                    alert('‚ùå Failed to check SOS status. Please try again.');
                });
        }

        // Check for existing SOS on page load
        window.addEventListener('DOMContentLoaded', function() {
            const lastSOSId = localStorage.getItem('lastSOSId');
            if (lastSOSId) {
                showSOSStatusButton(lastSOSId);
            }
        });

        // Panic Alert function
        function triggerPanicAlert() {
            const confirmed = confirm('‚ö†Ô∏è PANIC ALERT ‚ö†Ô∏è\n\nSend a panic alert?\n\nThis will:\n- Notify nearby authorities\n- Share your current location\n- Log the alert in the system\n\nConfirm only if you feel unsafe or threatened.');
            
            if (!confirmed) {
                return;
            }

            const btn = document.getElementById('panicBtn');
            btn.disabled = true;
            btn.innerHTML = '‚ö†Ô∏è SENDING ALERT...';
            btn.style.opacity = '0.6';

            // Get user's current location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        sendPanicAlert({
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        });
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        sendPanicAlert(null);
                    }
                );
            } else {
                sendPanicAlert(null);
            }
        }

        function sendPanicAlert(location) {
            const payload = {
                tourist_id: currentUser.user_id,
                timestamp: new Date().toISOString(),
                alert_type: 'panic',
                message: 'Panic alert triggered from user dashboard',
                severity: 'medium'
            };

            if (location) {
                payload.latitude = location.latitude;
                payload.longitude = location.longitude;
                payload.location = location;
            }

            fetch('/api/panic_alert', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                const btn = document.getElementById('panicBtn');
                btn.disabled = false;
                btn.style.opacity = '1';
                
                if (data.success) {
                    btn.innerHTML = '‚úÖ ALERT SENT!';
                    btn.style.background = '#28a745';
                    btn.style.color = 'white';
                    
                    alert('‚ö†Ô∏è PANIC ALERT SENT!\n\n‚úÖ Alert has been logged\n‚úÖ Authorities notified\n‚úÖ Your location has been shared\n\nStay safe and aware of your surroundings.');
                    
                    setTimeout(() => {
                        btn.innerHTML = '‚ö†Ô∏è PANIC ALERT ‚ö†Ô∏è';
                        btn.style.background = '#fff';
                        btn.style.color = '#ff6348';
                    }, 5000);
                } else {
                    btn.innerHTML = '‚ö†Ô∏è PANIC ALERT ‚ö†Ô∏è';
                    alert('‚ùå Failed to send panic alert: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Panic alert error:', error);
                const btn = document.getElementById('panicBtn');
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.innerHTML = '‚ö†Ô∏è PANIC ALERT ‚ö†Ô∏è';
                alert('‚ùå Failed to send panic alert due to network error.');
            });
        }

        // ============= AI MONITORING =============
        let aiMonitoringEnabled = false;
        let aiMonitoringInterval = null;

        function toggleAIMonitoring() {
            const btn = document.getElementById('aiMonitorBtn');
            const statusText = document.getElementById('aiStatusText');
            
            aiMonitoringEnabled = !aiMonitoringEnabled;
            
            if (aiMonitoringEnabled) {
                if (btn) {
                    btn.innerHTML = 'Disable AI Monitoring';
                    btn.style.background = '#28a745';
                    btn.style.color = 'white';
                }
                if (statusText) statusText.textContent = 'Active';
                startAIMonitoring();
            } else {
                if (btn) {
                    btn.innerHTML = 'Enable AI Monitoring';
                    btn.style.background = '#fff';
                    btn.style.color = '#667eea';
                }
                if (statusText) statusText.textContent = 'Disabled';
                stopAIMonitoring();
            }
        }

        function startAIMonitoring() {
            // Initial analysis
            analyzeWithAI();
            
            // Periodic monitoring every 5 minutes
            aiMonitoringInterval = setInterval(analyzeWithAI, 300000);
        }

        function stopAIMonitoring() {
            if (aiMonitoringInterval) {
                clearInterval(aiMonitoringInterval);
                aiMonitoringInterval = null;
            }
            const riskLevel = document.getElementById('aiRiskLevel');
            if (riskLevel) {
                riskLevel.textContent = '---';
            }
        }

        function analyzeWithAI() {
            if (!aiMonitoringEnabled) return;

            // Show analyzing status - add null check
            const statusText = document.getElementById('aiStatusText');
            if (!statusText) {
                console.warn('AI Status element not found');
                return;
            }
            statusText.textContent = 'Analyzing...';

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const payload = {
                            tourist_id: currentUser.user_id,
                            location: {
                                latitude: position.coords.latitude,
                                longitude: position.coords.longitude,
                                timestamp: new Date().toISOString()
                            },
                            behavior_data: {
                                last_activity: new Date().toISOString(),
                                device_type: navigator.platform
                            }
                        };
                        
                        console.log('Sending AI analysis request:', payload);

                        fetch('/api/ai/monitor/analyze', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        })
                        .then(response => {
                            console.log('AI Monitor Response Status:', response.status);
                            return response.json();
                        })
                        .then(data => {
                            console.log('AI Monitor Data:', data);
                            if (data.success && data.risk_level) {
                                const riskLevel = data.risk_level;
                                const riskEl = document.getElementById('aiRiskLevel');
                                
                                if (riskEl) {
                                    riskEl.textContent = riskLevel.toUpperCase();
                                    
                                    // Color code risk level
                                    if (riskLevel === 'high') {
                                        riskEl.style.color = '#ff4444';
                                    } else if (riskLevel === 'medium') {
                                        riskEl.style.color = '#ffaa00';
                                    } else {
                                        riskEl.style.color = '#00ff88';
                                    }
                                    console.log('Risk level updated to:', riskLevel);
                                    // Update status back to Active
                                    const statusTextEl = document.getElementById('aiStatusText');
                                    if (statusTextEl) {
                                        statusTextEl.textContent = 'Active';
                                    }
                                } else {
                                    console.error('aiRiskLevel element not found!');
                                }
                            } else {
                                console.error('Invalid response:', data);
                                const statusTextEl = document.getElementById('aiStatusText');
                                if (statusTextEl) {
                                    statusTextEl.textContent = 'Active';
                                }
                            }
                        })
                        .catch(error => {
                            console.error('AI monitoring error:', error);
                            const statusTextEl = document.getElementById('aiStatusText');
                            const riskLevelEl = document.getElementById('aiRiskLevel');
                            if (statusTextEl) {
                                statusTextEl.textContent = 'Error';
                            }
                            if (riskLevelEl) {
                                riskLevelEl.textContent = 'ERROR';
                            }
                        });
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        const statusTextEl = document.getElementById('aiStatusText');
                        if (statusTextEl) {
                            statusTextEl.textContent = 'Location Error';
                        }
                        alert('Unable to get your location. Please enable location services.');
                    }
                );
            } else {
                alert('Geolocation is not supported by your browser.');
            }
        }

        // ============= GEOFENCING =============
        let geofenceCheckInterval = null;

        function checkGeofence() {
            if (!isLocationSharing || !currentUser) return;
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;

                        // Check geofence violations
                        fetch('/api/geofence_violations?tourist_id=' + currentUser.user_id, {
                            method: 'GET'
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                const violations = data.violations || [];
                                const violationEl = document.getElementById('violationCount');
                                if (violationEl) {
                                    violationEl.textContent = violations.length;
                                }
                                
                                // Check current zone status
                                fetch(`/api/location/track`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        tourist_id: currentUser.user_id,
                                        latitude: lat,
                                        longitude: lng,
                                        timestamp: new Date().toISOString()
                                    })
                                })
                                .then(response => response.json())
                                .then(locationData => {
                                    const zoneEl = document.getElementById('currentZone');
                                    
                                    if (locationData.zone_status) {
                                        if (zoneEl) {
                                            zoneEl.textContent = locationData.zone_status;
                                            
                                            // Color code based on zone type
                                            if (locationData.zone_status.toLowerCase().includes('danger') || 
                                                locationData.zone_status.toLowerCase().includes('restricted')) {
                                                zoneEl.style.color = '#ff4444';
                                            } else if (locationData.zone_status.toLowerCase().includes('warning')) {
                                                zoneEl.style.color = '#ffaa00';
                                            } else {
                                                zoneEl.style.color = '#00ff88';
                                            }
                                        }
                                        
                                        // Alert for zone violations
                                        if (locationData.violation) {
                                            showNotification(`‚ö†Ô∏è ZONE ALERT: ${locationData.zone_status}`, 'warning');
                                        }
                                    } else {
                                        if (zoneEl) {
                                            zoneEl.textContent = 'Safe Zone';
                                            zoneEl.style.color = '#00ff88';
                                        }
                                    }
                                })
                                .catch(error => console.error('Location track error:', error));
                            }
                        })
                        .catch(error => console.error('Geofence check error:', error));
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
                );
            }
        }

        // Auto-check geofence every 2 minutes
        setInterval(checkGeofence, 120000);

        // ============= AUTO SOS DETECTION =============
        let autoSosEnabled = false;
        let autoSosInterval = null;
        let lastActivityTime = Date.now();

        function toggleAutoSOS() {
            const btn = document.getElementById('autoSosBtn');
            const statusText = document.getElementById('autoSosStatusText');
            
            autoSosEnabled = !autoSosEnabled;
            
            if (autoSosEnabled) {
                btn.innerHTML = 'Disable Auto SOS';
                btn.style.background = '#28a745';
                btn.style.color = 'white';
                statusText.textContent = 'Active';
                startAutoSOS();
            } else {
                btn.innerHTML = 'Enable Auto SOS';
                btn.style.background = '#fff';
                btn.style.color = '#fa709a';
                statusText.textContent = 'Disabled';
                stopAutoSOS();
            }
        }

        function startAutoSOS() {
            // Check status initially
            checkAutoSOSStatus();
            
            // Monitor every 10 minutes
            autoSosInterval = setInterval(checkAutoSOSStatus, 600000);
            
            // Track user activity
            document.addEventListener('mousemove', updateActivityTime);
            document.addEventListener('keypress', updateActivityTime);
            document.addEventListener('click', updateActivityTime);
        }

        function stopAutoSOS() {
            if (autoSosInterval) {
                clearInterval(autoSosInterval);
                autoSosInterval = null;
            }
            document.removeEventListener('mousemove', updateActivityTime);
            document.removeEventListener('keypress', updateActivityTime);
            document.removeEventListener('click', updateActivityTime);
        }

        function updateActivityTime() {
            lastActivityTime = Date.now();
        }

        function checkAutoSOSStatus() {
            if (!autoSosEnabled) return;

            const inactiveMinutes = (Date.now() - lastActivityTime) / 60000;
            
            fetch(`/api/auto-sos/status/${currentUser.user_id}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const lastCheck = new Date(data.last_check || Date.now()).toLocaleTimeString();
                    document.getElementById('autoSosLastCheck').textContent = lastCheck;
                    
                    // Evaluate risk based on inactivity
                    if (inactiveMinutes > 30) {
                        evaluateAutoSOS('high', 'Extended inactivity detected');
                    }
                }
            })
            .catch(error => console.error('Auto SOS status check error:', error));
        }

        function evaluateAutoSOS(riskLevel, reason) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const payload = {
                            user_id: currentUser.user_id,
                            risk_score: riskLevel === 'high' ? 0.8 : 0.5,
                            risk_level: riskLevel,
                            analysis_data: {
                                reason: reason,
                                timestamp: new Date().toISOString()
                            },
                            location: {
                                latitude: position.coords.latitude,
                                longitude: position.coords.longitude
                            }
                        };

                        fetch('/api/auto-sos/evaluate', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success && data.should_trigger) {
                                triggerAutoSOSAlert();
                            }
                        })
                        .catch(error => console.error('Auto SOS evaluation error:', error));
                    },
                    (error) => console.error('Geolocation error:', error)
                );
            }
        }

        function triggerAutoSOSAlert() {
            if (confirm('üö® AUTO SOS DETECTED POTENTIAL EMERGENCY\n\nAre you okay? Click OK if you need help, or Cancel if you are safe.')) {
                // User confirmed they need help
                sendEmergencySOS(null);
            } else {
                // User is safe, reset activity
                lastActivityTime = Date.now();
            }
        }

        // Initialize features on page load
        function initializeSafetyFeatures() {
            // Check geofence initially
            setTimeout(checkGeofence, 2000);
            
            // Load AI monitoring status
            fetch(`/api/ai/monitor/alerts`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.alerts && data.alerts.length > 0) {
                    console.log('Active AI alerts:', data.alerts.length);
                }
            })
            .catch(error => console.error('Error loading AI alerts:', error));
        }

        // Load documents on page load
        window.addEventListener('load', () => {
            loadAllDocuments();
            initializeSafetyFeatures();
        });
        
        // ========== NEW ENHANCED FEATURES ==========
        
        // Dark Theme Toggle
        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
            const isDark = document.body.classList.contains('dark-theme');
            localStorage.setItem('darkTheme', isDark);
            
            // Show notification
            const notification = document.createElement('div');
            notification.textContent = isDark ? 'üåô Dark theme enabled' : '‚òÄÔ∏è Light theme enabled';
            notification.style.cssText = 'position: fixed; top: 80px; right: 20px; background: #667eea; color: white; padding: 15px 25px; border-radius: 10px; z-index: 10000; animation: slideInRight 0.5s; box-shadow: 0 5px 15px rgba(0,0,0,0.3);';
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }
        
        // Load saved theme preference
        if (localStorage.getItem('darkTheme') === 'true') {
            document.body.classList.add('dark-theme');
        }
        
        // AI Safety Monitoring with Location Sharing
        let locationWatchId = null;
        let isLocationSharing = false;
        
        function toggleLocationSharing(enabled) {
            isLocationSharing = enabled;
            const statusText = document.getElementById('locationStatusText');
            const statusIcon = document.getElementById('locationStatusIcon');
            const currentLocationText = document.getElementById('currentLocationText');
            const headerLocationStatus = document.getElementById('headerLocationStatus');
            const headerLocationToggle = document.getElementById('headerLocationToggle');
            
            // Update header status
            if (headerLocationStatus) {
                headerLocationStatus.textContent = enabled ? 'ACTIVE' : 'OFF';
                headerLocationStatus.style.color = enabled ? '#00ff88' : '#ff4444';
            }
            
            // Sync header toggle
            if (headerLocationToggle && headerLocationToggle.checked !== enabled) {
                headerLocationToggle.checked = enabled;
            }
            
            if (enabled) {
                if (statusText) statusText.textContent = 'Active üü¢';
                if (statusIcon) {
                    statusIcon.textContent = 'üìç';
                    statusIcon.style.animation = 'pulse 2s infinite';
                }
                
                // Start watching location
                if (navigator.geolocation) {
                    locationWatchId = navigator.geolocation.watchPosition(
                        (position) => {
                            const { latitude, longitude } = position.coords;
                            if (currentLocationText) {
                                currentLocationText.textContent = `Lat: ${latitude.toFixed(4)}, Lng: ${longitude.toFixed(4)}`;
                            }
                            
                            // Send location to server
                            fetch('/api/location/share', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ 
                                    tourist_id: currentUser ? currentUser.user_id : '',
                                    latitude, 
                                    longitude, 
                                    timestamp: Date.now() 
                                })
                            }).catch(err => console.error('Location share error:', err));
                            
                            // Update geofence status
                            checkGeofence();
                        },
                        (error) => {
                            console.error('Geolocation error:', error);
                            if (currentLocationText) {
                                currentLocationText.textContent = '‚ùå Unable to get location';
                            }
                        },
                        { enableHighAccuracy: true, maximumAge: 10000, timeout: 5000 }
                    );
                }
                
                showNotification('‚úÖ Location sharing enabled! Your location is now being tracked.', 'success');
            } else {
                if (statusText) statusText.textContent = 'Inactive üî¥';
                if (statusIcon) {
                    statusIcon.textContent = 'üìç';
                    statusIcon.style.animation = 'none';
                }
                if (currentLocationText) {
                    currentLocationText.textContent = 'Enable monitoring to share your location';
                }
                
                // Stop watching location
                if (locationWatchId) {
                    navigator.geolocation.clearWatch(locationWatchId);
                    locationWatchId = null;
                }
                
                showNotification('Location sharing disabled', 'info');
            }
            
            // Save preference to server
            fetch('/api/toggle_location_sharing', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    tourist_id: currentUser ? currentUser.user_id : '',
                    enabled: enabled
                })
            }).catch(err => console.error('Error saving location preference:', err));
        }
        
        function enableAIMonitoring() {
            const toggle = document.getElementById('locationToggle');
            if (!toggle.checked) {
                toggle.checked = true;
                toggleLocationSharing(true);
            }
            showNotification('üöÄ AI Safety Monitoring activated! You are now being monitored for your safety.', 'success');
        }
        
        function viewSafetyMap() {
            showNotification('üó∫Ô∏è Opening Safety Map...', 'info');
            // This would open a full-screen map with safe zones and current location
            window.open('/safety-map', '_blank');
        }
        
        // Interactive Tutorial System
        function startTutorial() {
            const steps = [
                { element: '.user-info-card', title: 'Your Profile', text: 'This is your user information. Keep it updated for better safety!' },
                { element: '#emergencyBtn', title: 'Emergency SOS', text: 'Press this button in real emergencies. Help will be dispatched immediately!' },
                { element: '#locationToggle', title: 'Location Sharing', text: 'Enable this to share your live location with trusted contacts.' },
                { element: '#uploadArea', title: 'Upload Documents', text: 'Upload your travel documents here. They are encrypted and blockchain-verified!' }
            ];
            
            let currentStep = 0;
            
            function showStep(stepIndex) {
                if (stepIndex >= steps.length) {
                    endTutorial();
                    return;
                }
                
                const step = steps[stepIndex];
                const element = document.querySelector(step.element);
                
                if (!element) {
                    currentStep++;
                    showStep(currentStep);
                    return;
                }
                
                // Create tutorial overlay
                const overlay = document.createElement('div');
                overlay.id = 'tutorial-overlay';
                overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9998; animation: fadeIn 0.3s;';
                
                // Create tutorial popup
                const popup = document.createElement('div');
                popup.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; z-index: 9999; max-width: 500px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); animation: fadeInDown 0.5s;';
                popup.innerHTML = `
                    <h2 style="color: #667eea; margin: 0 0 15px 0;">${step.title}</h2>
                    <p style="color: #2d3436; font-size: 1.1em; margin: 15px 0;">${step.text}</p>
                    <div style="display: flex; justify-content: space-between; margin-top: 25px;">
                        <button onclick="endTutorial()" style="background: #e74c3c; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 1em;">Skip Tour</button>
                        <button onclick="nextTutorialStep()" style="background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 1em;">Next (${stepIndex + 1}/${steps.length})</button>
                    </div>
                `;
                
                // Highlight the element
                element.style.position = 'relative';
                element.style.zIndex = '9999';
                element.style.boxShadow = '0 0 0 5px #667eea, 0 0 20px rgba(102, 126, 234, 0.5)';
                element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                document.body.appendChild(overlay);
                document.body.appendChild(popup);
                
                overlay.onclick = endTutorial;
            }
            
            window.nextTutorialStep = function() {
                currentStep++;
                endTutorial();
                setTimeout(() => showStep(currentStep), 300);
            };
            
            window.endTutorial = function() {
                const overlay = document.getElementById('tutorial-overlay');
                if (overlay) overlay.remove();
                const popups = document.querySelectorAll('[style*="z-index: 9999"]');
                popups.forEach(p => {
                    if (p.id !== 'tutorial-overlay') p.remove();
                });
                // Remove highlights
                document.querySelectorAll('.dashboard-card').forEach(card => {
                    card.style.boxShadow = '';
                    card.style.zIndex = '';
                });
                document.querySelectorAll('button').forEach(btn => {
                    btn.style.boxShadow = '';
                    btn.style.zIndex = '';
                });
                
                if (currentStep >= steps.length) {
                    showNotification('üéâ Tutorial completed! You are now a safety expert!', 'success');
                }
            };
            
            showStep(0);
        }
        
        // Enhanced Notification System
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: ${type === 'success' ? '#00b894' : type === 'error' ? '#d63031' : '#667eea'};
                color: white;
                padding: 18px 25px;
                border-radius: 12px;
                z-index: 10000;
                animation: slideInRight 0.5s;
                box-shadow: 0 6px 20px rgba(0,0,0,0.25);
                max-width: 350px;
                font-size: 1.05em;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.5s reverse';
                setTimeout(() => notification.remove(), 500);
            }, 4000);
        }

        // Initialize location status on page load
        function initializeLocationStatus() {
            // Fetch current user settings
            fetch('/api/get_tourist_settings?tourist_id=' + (currentUser ? currentUser.user_id : ''))
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.settings) {
                        const locationEnabled = data.settings.location_sharing_enabled || false;
                        const toggle = document.getElementById('headerLocationToggle');
                        const statusText = document.getElementById('headerLocationStatus');
                        
                        if (toggle) {
                            toggle.checked = locationEnabled;
                        }
                        
                        if (statusText) {
                            statusText.textContent = locationEnabled ? 'ACTIVE' : 'OFF';
                            statusText.style.color = locationEnabled ? '#00ff88' : '#ff4444';
                        }
                        
                        // Auto-enable if setting says so
                        if (locationEnabled) {
                            toggleLocationSharing(true);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading location settings:', error);
                });
        }

        // Initialize risk level display
        function initializeRiskLevel() {
            // Fetch current risk level
            if (currentUser && currentUser.user_id) {
                fetch('/api/get_risk_level?tourist_id=' + currentUser.user_id)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.risk_level) {
                            updateRiskLevelDisplay(data.risk_level, data.risk_factors || []);
                        }
                    })
                    .catch(error => {
                        console.error('Error loading risk level:', error);
                    });
            }
        }

        // Update risk level display
        function updateRiskLevelDisplay(riskLevel, riskFactors) {
            const riskBadge = document.getElementById('riskLevelBadge');
            const riskText = document.getElementById('riskLevelText');
            const riskCard = document.getElementById('riskLevelCard');
            
            if (riskBadge) {
                riskBadge.textContent = riskLevel.toUpperCase();
                
                // Color code the risk level and card
                if (riskLevel === 'high' || riskLevel === 'critical') {
                    if (riskCard) {
                        riskCard.style.background = 'linear-gradient(135deg, #ff4444, #cc0000)';
                    }
                    riskBadge.style.color = 'white';
                } else if (riskLevel === 'medium' || riskLevel === 'moderate') {
                    if (riskCard) {
                        riskCard.style.background = 'linear-gradient(135deg, #ffaa00, #ff8800)';
                    }
                    riskBadge.style.color = 'white';
                } else {
                    if (riskCard) {
                        riskCard.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                    }
                    riskBadge.style.color = 'white';
                }
            }
            
            if (riskText) {
                if (riskFactors && riskFactors.length > 0) {
                    riskText.textContent = riskFactors.join(', ');
                } else {
                    riskText.textContent = riskLevel === 'low' ? 'Safe conditions' : (riskLevel === 'medium' ? 'Be cautious' : 'High alert');
                }
            }
        }

        // Load documents on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadAllDocuments();
            
            // Initialize location status from user preferences
            initializeLocationStatus();
            
            // Initialize risk level display
            initializeRiskLevel();
            
            // Auto-check geofence every 2 minutes
            setInterval(checkGeofence, 120000);
        });
        
        // üéØ TAB SWITCHING FUNCTIONALITY
        function switchTab(event, tabName) {
            // Hide all tab contents
            const tabContents = document.getElementsByClassName('tab-content');
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove('active');
            }
            
            // Remove active class from all tab buttons
            const tabButtons = document.getElementsByClassName('tab-button');
            for (let i = 0; i < tabButtons.length; i++) {
                tabButtons[i].classList.remove('active');
            }
            
            // Show the selected tab content
            const selectedTab = document.getElementById('tab-' + tabName);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Add active class to the clicked button
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }
        }
        
        // üé¥ ACCORDION TOGGLE FUNCTIONALITY
        function toggleAccordion(header) {
            const content = header.nextElementSibling;
            const isActive = header.classList.contains('active');
            
            if (isActive) {
                // Close the accordion
                header.classList.remove('active');
                content.classList.remove('active');
            } else {
                // Open the accordion
                header.classList.add('active');
                content.classList.add('active');
            }
        }
        
        // Emergency Contact Functions - REMOVED
        function addEmergencyContact() {
            showNotification('Feature removed for simplified interface', 'info');
        }
        
        function viewSafetyMap() {
            showNotification('üó∫Ô∏è Opening Safety Map...', 'info');
            // Could redirect to a map page or open a modal
        }
        
        // üö® EMERGENCY CONFIRMATION MODAL
        function confirmEmergency() {
            if (confirm('‚ö†Ô∏è EMERGENCY CONFIRMATION\n\nThis will immediately alert:\n‚úì Local authorities\n‚úì Emergency services\n‚úì Your emergency contacts\n\nYour location will be shared in real-time.\n\nPress OK to confirm this is a REAL EMERGENCY.')) {
                triggerEmergency();
            }
        }
        
        // üéØ FLOATING EMERGENCY MENU
        function showEmergencyMenu() {
            const menu = document.getElementById('emergencyMenu');
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }
        
        function hideEmergencyMenu() {
            document.getElementById('emergencyMenu').style.display = 'none';
        }
        
        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('emergencyMenu');
            const btn = document.getElementById('floatingEmergencyBtn');
            if (menu && btn && !btn.contains(event.target) && !menu.contains(event.target)) {
                menu.style.display = 'none';
            }
        });
        
        // üèÜ BADGE SHOWCASE
        function showBadgeShowcase() {
            document.getElementById('badgeShowcaseModal').style.display = 'flex';
        }
        
        // üìä SAFETY BREAKDOWN
        function showSafetyBreakdown() {
            document.getElementById('safetyBreakdownModal').style.display = 'flex';
        }
        
        // üîî NOTIFICATION MANAGEMENT
        function dismissNotifications() {
            const notificationsList = document.getElementById('notificationsList');
            if (notificationsList) {
                notificationsList.innerHTML = '<p style="text-align: center; opacity: 0.8; padding: 24px;">All caught up! No new notifications.</p>';
            }
        }
        
        // üìÅ DRAG & DROP FILE HANDLING
        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            const uploadArea = document.getElementById('uploadAreaPriority');
            const dropFeedback = document.getElementById('dropFeedback');
            if (uploadArea) {
                uploadArea.style.borderColor = '#00b894';
                uploadArea.style.background = 'linear-gradient(135deg, #d4f4dd, #c3f0d3)';
                uploadArea.style.transform = 'scale(1.02)';
            }
            if (dropFeedback) {
                dropFeedback.style.display = 'flex';
            }
        }
        
        function handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            const uploadArea = document.getElementById('uploadAreaPriority');
            const dropFeedback = document.getElementById('dropFeedback');
            if (uploadArea) {
                uploadArea.style.borderColor = '#00b894';
                uploadArea.style.background = 'linear-gradient(135deg, #e3f2fd, #bbdefb)';
                uploadArea.style.transform = 'scale(1)';
            }
            if (dropFeedback) {
                dropFeedback.style.display = 'none';
            }
        }
        
        function handleDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            handleDragLeave(event);
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                // Add files to the file input
                const fileInput = document.getElementById('fileInput');
                if (fileInput) {
                    fileInput.files = files;
                    showNotification(`üìÅ ${files.length} file(s) ready to upload!`, 'success');
                    
                    // Show file names
                    let fileNames = [];
                    for (let i = 0; i < files.length; i++) {
                        fileNames.push(files[i].name);
                    }
                    console.log('Files ready:', fileNames.join(', '));
                }
            }
        }
        
        // üì§ ENHANCED UPLOAD WITH PROGRESS
        const originalUploadFiles = window.uploadFiles;
        window.uploadFiles = function() {
            const fileInput = document.getElementById('fileInput');
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                showNotification('‚ö†Ô∏è Please select files to upload first!', 'error');
                return;
            }
            
            // Show progress UI
            const progressDiv = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBar');
            const uploadStatus = document.getElementById('uploadStatus');
            const uploadFileName = document.getElementById('uploadFileName');
            
            if (progressDiv) progressDiv.style.display = 'block';
            
            // Simulate upload progress (in real implementation, track actual upload)
            let progress = 0;
            const interval = setInterval(() => {
                progress += 10;
                if (progressBar) progressBar.style.width = progress + '%';
                if (uploadStatus) uploadStatus.textContent = progress + '%';
                
                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        if (progressDiv) progressDiv.style.display = 'none';
                        showNotification('‚úÖ Files uploaded successfully!', 'success');
                        loadAllDocuments(); // Refresh document list
                    }, 500);
                }
            }, 200);
            
            if (uploadFileName && fileInput.files[0]) {
                uploadFileName.textContent = fileInput.files[0].name;
            }
            
            // Call original upload function
            if (originalUploadFiles) {
                originalUploadFiles();
            }
        };
        
        // ‚è∞ UPDATE TIMESTAMP
        function updateLastUpdated() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            const element = document.getElementById('lastUpdated');
            if (element) {
                element.textContent = timeString;
            }
        }
        
        // Update timestamp every minute
        setInterval(updateLastUpdated, 60000);
        updateLastUpdated();
        
        // üé¨ SCROLL ANIMATIONS
        function handleScroll() {
            const heroSection = document.getElementById('heroSection');
            if (heroSection && window.scrollY > 100) {
                // Show sticky emergency bar when scrolled down
                // document.getElementById('stickyEmergencyBar').style.transform = 'translateY(0)';
            }
        }
        
        window.addEventListener('scroll', handleScroll);

        /* ========================================
           üöÄ NEW UX IMPROVEMENT FUNCTIONS
           ======================================== */

        // üîç GLOBAL SEARCH FUNCTIONALITY
        let searchTimeout;
        const searchableItems = [
            { title: 'Emergency SOS', category: 'Emergency', icon: 'üÜò', action: () => triggerEmergency() },
            { title: 'Panic Alert', category: 'Emergency', icon: '‚ö†Ô∏è', action: () => triggerPanicAlert() },
            { title: 'Upload Documents', category: 'Documents', icon: 'üìÑ', action: () => switchTab(null, 'documents') },
            { title: 'View Documents', category: 'Documents', icon: 'üëÅÔ∏è', action: () => switchTab(null, 'documents') },
            { title: 'Location Sharing', category: 'Location', icon: 'üìç', action: () => switchTab(null, 'location') },
            { title: 'AI Monitoring', category: 'Safety', icon: 'ü§ñ', action: () => enableAIMonitoring() },
            { title: 'Profile Settings', category: 'Settings', icon: '‚öôÔ∏è', action: () => switchTab(null, 'settings') },
            { title: 'Badges & Achievements', category: 'Achievements', icon: 'üèÜ', action: () => showBadgeShowcase() },
            { title: 'Safety Score', category: 'Safety', icon: 'üõ°Ô∏è', action: () => showSafetyBreakdown() },
            { title: 'Help & Support', category: 'Help', icon: '‚ùì', action: () => alert('Help center coming soon!') }
        ];

        function performGlobalSearch(query) {
            clearTimeout(searchTimeout);
            const resultsContainer = document.getElementById('searchResults');
            
            if (!query || query.length < 2) {
                resultsContainer.classList.remove('active');
                return;
            }

            searchTimeout = setTimeout(() => {
                const results = searchableItems.filter(item => 
                    item.title.toLowerCase().includes(query.toLowerCase()) ||
                    item.category.toLowerCase().includes(query.toLowerCase())
                );

                if (results.length === 0) {
                    resultsContainer.innerHTML = '<div class="search-result-item" style="text-align: center; color: #9ca3af;">No results found</div>';
                } else {
                    resultsContainer.innerHTML = results.map(item => `
                        <div class="search-result-item" onclick='${item.action.toString().replace(/'/g, "\\'")}'>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="font-size: 1.5em;">${item.icon}</span>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: #2c3e50;">${item.title}</div>
                                    <div style="font-size: 0.85em; color: #9ca3af;">${item.category}</div>
                                </div>
                                <span style="color: #667eea;">‚Üí</span>
                            </div>
                        </div>
                    `).join('');
                }

                resultsContainer.classList.add('active');
            }, 300);
        }

        // Close search results when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.global-search-container')) {
                document.getElementById('searchResults').classList.remove('active');
            }
        });

        // üìä CIRCULAR PROGRESS INDICATOR
        function updateCircularProgress(percentage) {
            const circle = document.querySelector('.progress-bar');
            const circumference = 2 * Math.PI * 70; // radius = 70
            const offset = circumference - (percentage / 100) * circumference;
            
            if (circle) {
                circle.style.strokeDashoffset = offset;
            }
            
            const percentageText = document.querySelector('.progress-percentage');
            if (percentageText) {
                let current = 0;
                const interval = setInterval(() => {
                    if (current >= percentage) {
                        clearInterval(interval);
                    } else {
                        current++;
                        percentageText.textContent = current + '%';
                    }
                }, 15);
            }
        }

        // üìÅ DOCUMENT SEARCH & FILTER
        let currentFilter = 'all';
        let searchQuery = '';

        function filterDocuments(filter) {
            currentFilter = filter;
            applyDocumentFilters();
            
            // Update active filter tag
            document.querySelectorAll('.filter-tag').forEach(tag => {
                tag.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function searchDocuments(query) {
            searchQuery = query.toLowerCase();
            applyDocumentFilters();
        }

        function applyDocumentFilters() {
            const documentItems = document.querySelectorAll('.file-item');
            
            documentItems.forEach(item => {
                const fileName = item.querySelector('.file-info')?.textContent.toLowerCase() || '';
                const docType = item.dataset.type || '';
                
                const matchesSearch = fileName.includes(searchQuery);
                const matchesFilter = currentFilter === 'all' || docType === currentFilter;
                
                if (matchesSearch && matchesFilter) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // üì§ BULK UPLOAD WITH PREVIEWS
        let filesToUpload = [];

        function handleFileSelection(files) {
            filesToUpload = Array.from(files);
            displayUploadPreviews();
        }

        function displayUploadPreviews() {
            const container = document.getElementById('uploadPreviewContainer');
            const grid = document.getElementById('uploadPreviewGrid');
            
            if (!container || !grid) return;

            if (filesToUpload.length === 0) {
                container.classList.remove('active');
                return;
            }

            container.classList.add('active');
            
            grid.innerHTML = filesToUpload.map((file, index) => {
                const icon = getFileIcon(file.name);
                const size = formatFileSize(file.size);
                
                return `
                    <div class="upload-preview-item" data-index="${index}">
                        <button class="upload-preview-remove" onclick="removeFileFromUpload(${index})">√ó</button>
                        <div class="upload-preview-icon">${icon}</div>
                        <div class="upload-preview-name" title="${file.name}">${truncateFileName(file.name)}</div>
                        <div class="upload-preview-size">${size}</div>
                        <div class="upload-preview-progress">
                            <div class="upload-preview-progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function removeFileFromUpload(index) {
            filesToUpload.splice(index, 1);
            displayUploadPreviews();
        }

        function getFileIcon(fileName) {
            const ext = fileName.split('.').pop().toLowerCase();
            const icons = {
                'pdf': 'üìï',
                'doc': 'üìò',
                'docx': 'üìò',
                'jpg': 'üñºÔ∏è',
                'jpeg': 'üñºÔ∏è',
                'png': 'üñºÔ∏è',
                'gif': 'üñºÔ∏è',
                'zip': 'üì¶',
                'rar': 'üì¶',
                'txt': 'üìÑ'
            };
            return icons[ext] || 'üìÑ';
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function truncateFileName(name, maxLength = 20) {
            if (name.length <= maxLength) return name;
            const ext = name.split('.').pop();
            const nameWithoutExt = name.substring(0, name.lastIndexOf('.'));
            const truncated = nameWithoutExt.substring(0, maxLength - ext.length - 4) + '...';
            return truncated + '.' + ext;
        }

        // üé† TESTIMONIALS CAROUSEL
        let currentTestimonial = 0;
        const testimonials = [
            {
                text: "This app saved my trip! The AI monitoring detected I was lost and sent help immediately.",
                author: "Sarah Johnson",
                role: "Solo Traveler",
                avatar: "https://i.pravatar.cc/150?img=1"
            },
            {
                text: "The document management is brilliant. All my travel papers in one secure place!",
                author: "Michael Chen",
                role: "Business Traveler",
                avatar: "https://i.pravatar.cc/150?img=2"
            },
            {
                text: "Emergency SOS feature gave my family peace of mind during my solo adventure.",
                author: "Emma Wilson",
                role: "Adventure Enthusiast",
                avatar: "https://i.pravatar.cc/150?img=3"
            }
        ];

        function initTestimonialCarousel() {
            setInterval(() => {
                currentTestimonial = (currentTestimonial + 1) % testimonials.length;
                updateTestimonialDisplay();
            }, 5000); // Auto-rotate every 5 seconds
        }

        function updateTestimonialDisplay() {
            const track = document.querySelector('.testimonial-track');
            if (track) {
                track.style.transform = `translateX(-${currentTestimonial * 100}%)`;
            }
            
            // Update dots
            document.querySelectorAll('.carousel-dot').forEach((dot, index) => {
                dot.classList.toggle('active', index === currentTestimonial);
            });
        }

        // üèÜ ACHIEVEMENT POPUP
        function showAchievementPopup(title, message, icon = 'üèÜ') {
            const popup = document.getElementById('achievementPopup');
            if (!popup) {
                // Create popup if it doesn't exist
                const popupHTML = `
                    <div id="achievementPopup" class="achievement-popup">
                        <div class="achievement-popup-icon">${icon}</div>
                        <div class="achievement-popup-title">${title}</div>
                        <div class="achievement-popup-message">${message}</div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', popupHTML);
            }
            
            const achievementPopup = document.getElementById('achievementPopup');
            achievementPopup.classList.add('show');
            
            setTimeout(() => {
                achievementPopup.classList.remove('show');
            }, 4000);
        }

        // ‚ö†Ô∏è CHECK FOR EXPIRING DOCUMENTS
        function checkExpiringDocuments() {
            // Simulated - in real app, check document expiry dates
            const expiringDocs = [
                { name: 'Passport', daysLeft: 25 },
                { name: 'Travel Insurance', daysLeft: 10 }
            ];
            
            if (expiringDocs.length > 0) {
                const doc = expiringDocs[0];
                if (doc.daysLeft <= 30) {
                    showExpiryBanner(doc.name, doc.daysLeft);
                }
            }
        }

        function showExpiryBanner(docName, daysLeft) {
            const banner = document.getElementById('expiryBanner');
            if (!banner) return;
            
            const message = daysLeft <= 7 ? 
                `‚ö†Ô∏è URGENT: Your ${docName} expires in ${daysLeft} days!` :
                `‚è∞ Reminder: Your ${docName} expires in ${daysLeft} days`;
            
            banner.querySelector('.expiry-banner-message').textContent = message;
            banner.style.display = 'flex';
        }

        // üéØ INITIALIZE ALL NEW FEATURES
        window.addEventListener('DOMContentLoaded', () => {
            // Initialize circular progress
            updateCircularProgress(85);
            
            // Initialize testimonial carousel
            initTestimonialCarousel();
            
            // Check for expiring documents
            checkExpiringDocuments();
            
            // Load recent activity
            loadRecentActivity();
            
            // Load user documents
            loadUserDocuments();
            
            // Load system status
            loadSystemStatus();
            
            // Show welcome achievement for new users
            setTimeout(() => {
                showAchievementPopup('Welcome!', 'Your journey to safer travel begins now! üéâ', 'üéä');
            }, 2000);
        });

        // ========================================
        // üìã RECENT ACTIVITY LOADER
        // ========================================

        function loadRecentActivity() {
            const container = document.getElementById('recentActivityContainer');
            if (!container) return;

            // Simulate loading recent activity (in production, fetch from backend)
            setTimeout(() => {
                const activities = generateRecentActivities();
                
                if (activities.length === 0) {
                    container.innerHTML = `
                        <p style="color: #6c757d; margin: 0;">
                            <span class="icon-info"></span> No recent activity. Start by uploading documents or enabling location tracking!
                        </p>
                    `;
                } else {
                    container.innerHTML = activities.map(activity => `
                        <div style="padding: 12px 0; border-bottom: 1px solid #e5e7eb;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="font-size: 1.5em;">${activity.icon}</span>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: #2c3e50; margin-bottom: 4px;">${activity.title}</div>
                                    <div style="font-size: 0.9em; color: #6c757d;">${activity.description}</div>
                                    <div style="font-size: 0.85em; color: #9ca3af; margin-top: 4px;">üïí ${activity.time}</div>
                                </div>
                                <span class="status-${activity.status}" style="padding: 4px 12px; font-size: 0.85em; white-space: nowrap;">${activity.statusText}</span>
                            </div>
                        </div>
                    `).join('');
                }
            }, 500);
        }

        function generateRecentActivities() {
            const activities = [];
            
            // Check if Safety Map was enabled
            if (isMapEnabled) {
                activities.push({
                    icon: 'üó∫Ô∏è',
                    title: 'Safety Map Enabled',
                    description: 'Real-time location tracking activated',
                    time: 'Just now',
                    status: 'safe',
                    statusText: 'Active'
                });
            }
            
            // Check for journey history
            if (journeyHistory && Object.keys(journeyHistory).length > 0) {
                const today = new Date().toISOString().split('T')[0];
                const todayJourney = journeyHistory[today];
                if (todayJourney && todayJourney.length > 0) {
                    activities.push({
                        icon: 'üö∂',
                        title: 'Journey Tracked',
                        description: `${todayJourney.length} stops recorded today`,
                        time: '2 hours ago',
                        status: 'safe',
                        statusText: 'Completed'
                    });
                }
            }
            
            // Check for risk alerts
            if (alertsDatabase && alertsDatabase.length > 0) {
                const criticalAlerts = alertsDatabase.filter(a => a.severity === 'critical');
                if (criticalAlerts.length > 0) {
                    activities.push({
                        icon: 'üö®',
                        title: 'Safety Alert Received',
                        description: `${criticalAlerts.length} critical alert(s) in risky zones`,
                        time: '1 hour ago',
                        status: 'danger',
                        statusText: 'Attention'
                    });
                }
            }
            
            // Add AI monitoring activity
            activities.push({
                icon: 'ü§ñ',
                title: 'AI Safety Monitoring',
                description: 'Continuous safety analysis active',
                time: '3 hours ago',
                status: 'safe',
                statusText: 'Running'
            });
            
            // Add Auto SOS detection status
            activities.push({
                icon: 'üõ°Ô∏è',
                title: 'Auto SOS Detection',
                description: 'Emergency detection system monitoring',
                time: '3 hours ago',
                status: 'safe',
                statusText: 'Protected'
            });
            
            // Add location tracking if available
            if (locationHistory && locationHistory.length > 0) {
                activities.push({
                    icon: 'üìç',
                    title: 'Location Updated',
                    description: `${locationHistory.length} location points tracked`,
                    time: '30 minutes ago',
                    status: 'safe',
                    statusText: 'Tracking'
                });
            }
            
            return activities.slice(0, 5); // Return max 5 recent activities
        }

        // ========================================
        // üìÑ DOCUMENT LOADER
        // ========================================

        function loadUserDocuments() {
            fetch('/api/user/documents')
                .then(response => {
                    if (!response.ok) {
                        console.warn('Documents endpoint returned:', response.status);
                        return { documents: [] };
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('‚úÖ Documents loaded:', data.documents ? data.documents.length : 0);
                    if (data.documents && data.documents.length > 0) {
                        updateDocumentDisplay(data.documents);
                    }
                })
                .catch(error => {
                    console.error('‚ö†Ô∏è Error loading documents:', error);
                    // Silently fail - UI already has default state
                });
        }

        function updateDocumentDisplay(documents) {
            // Update document count in UI if element exists
            const docCountElement = document.getElementById('documentCount');
            if (docCountElement) {
                docCountElement.textContent = documents.length;
            }
            
            // Add to recent activity if documents exist
            const container = document.getElementById('recentActivityContainer');
            if (container && documents.length > 0) {
                const existingHTML = container.innerHTML;
                const docActivity = `
                    <div style="padding: 12px 0; border-bottom: 1px solid #e5e7eb;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 1.5em;">üìÑ</span>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #2c3e50; margin-bottom: 4px;">Documents Uploaded</div>
                                <div style="font-size: 0.9em; color: #6c757d;">${documents.length} document(s) verified</div>
                                <div style="font-size: 0.85em; color: #9ca3af; margin-top: 4px;">üïí Recently</div>
                            </div>
                            <span class="status-safe" style="padding: 4px 12px; font-size: 0.85em; white-space: nowrap;">Verified</span>
                        </div>
                    </div>
                `;
                
                // Add document activity at the top
                if (existingHTML.includes('Loading') || existingHTML.includes('No recent activity')) {
                    container.innerHTML = docActivity;
                } else {
                    container.insertAdjacentHTML('afterbegin', docActivity);
                }
            }
        }

        // ========================================
        // üõ°Ô∏è SYSTEM STATUS LOADER
        // ========================================

        function loadSystemStatus() {
            fetch('/api/system/status')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.features) {
                        updateSystemStatusDisplay(data.features);
                        console.log('‚úÖ System status loaded:', data.features);
                    }
                })
                .catch(error => {
                    console.error('‚ö†Ô∏è Error loading system status:', error);
                });
        }

        function updateSystemStatusDisplay(features) {
            // Update AI Monitoring status
            const aiStatus = document.getElementById('aiMonitoringStatus');
            if (aiStatus) {
                const aiEnabled = features.ai_monitoring?.enabled;
                aiStatus.className = 'status-badge ' + (aiEnabled ? 'status-safe' : 'status-danger');
                aiStatus.textContent = aiEnabled ? 'Active ‚úì' : 'Inactive';
            }

            // Update Auto SOS status
            const sosStatus = document.getElementById('autoSosStatus');
            if (sosStatus) {
                const sosEnabled = features.auto_sos?.enabled;
                sosStatus.className = 'status-badge ' + (sosEnabled ? 'status-safe' : 'status-danger');
                sosStatus.textContent = sosEnabled ? 'Active ‚úì' : 'Inactive';
            }

            // Update Location Tracking status
            const locStatus = document.getElementById('locationStatus');
            if (locStatus) {
                if (isMapEnabled) {
                    locStatus.className = 'status-badge status-safe';
                    locStatus.textContent = 'Active ‚úì';
                } else {
                    locStatus.className = 'status-badge status-warning';
                    locStatus.textContent = 'Ready';
                }
            }

            // Update Safety Map status
            const mapStatus = document.getElementById('safetyMapStatus');
            if (mapStatus) {
                if (isMapEnabled) {
                    mapStatus.className = 'status-badge status-safe';
                    mapStatus.textContent = 'Active ‚úì';
                } else {
                    mapStatus.className = 'status-badge status-warning';
                    mapStatus.textContent = 'Ready';
                }
            }
        }

        function refreshSystemStatus() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span>üîÑ</span> Refreshing...';
            btn.disabled = true;

            loadSystemStatus();

            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
                showAchievementPopup('Status Updated', 'All protection systems are operational', '‚úÖ');
            }, 1000);
        }

        // ========================================
        // üó∫Ô∏è INTERACTIVE SAFETY MAP FUNCTIONS
        // ========================================

        let safetyMapInstance = null;
        let userMarker = null;
        let journeyPolyline = null;
        let safetyZones = [];
        let isMapEnabled = false;
        let locationHistory = [];
        let mapUpdateInterval = null;

        // Sample safety zones data (In production, fetch from backend)
        const sampleSafetyZones = [
            {
                name: "Tourist District",
                type: "safe",
                coordinates: [
                    [28.6139, 77.2090],
                    [28.6150, 77.2100],
                    [28.6140, 77.2110],
                    [28.6130, 77.2100]
                ]
            },
            {
                name: "Market Area",
                type: "moderate",
                coordinates: [
                    [28.6120, 77.2085],
                    [28.6125, 77.2095],
                    [28.6115, 77.2105],
                    [28.6110, 77.2095]
                ]
            },
            {
                name: "Restricted Zone",
                type: "restricted",
                coordinates: [
                    [28.6100, 77.2075],
                    [28.6105, 77.2085],
                    [28.6095, 77.2095],
                    [28.6090, 77.2085]
                ]
            }
        ];

        function initializeSafetyMap() {
            if (safetyMapInstance) return; // Already initialized

            // Center map on Delhi, India (default)
            const defaultLat = 28.6139;
            const defaultLng = 77.2090;

            safetyMapInstance = L.map('safetyMap', {
                zoomControl: false
            }).setView([defaultLat, defaultLng], 13);

            // Add custom zoom control
            L.control.zoom({
                position: 'bottomright'
            }).addTo(safetyMapInstance);

            // Add tile layer (OpenStreetMap)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(safetyMapInstance);

            // Add user marker
            const userIcon = L.divIcon({
                html: '<div style="background: linear-gradient(135deg, #667eea, #764ba2); width: 30px; height: 30px; border-radius: 50%; border: 4px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 16px;">üìç</div>',
                iconSize: [30, 30],
                className: ''
            });

            userMarker = L.marker([defaultLat, defaultLng], { icon: userIcon }).addTo(safetyMapInstance);
            userMarker.bindPopup(`
                <div class="custom-popup">
                    <div class="popup-header">Your Current Location</div>
                    <div class="popup-body">
                        <p>üìç <strong>Tourist District</strong></p>
                        <p>üõ°Ô∏è Status: <strong style="color: #4ade80;">Safe Zone</strong></p>
                        <p>üïí Updated: Just now</p>
                    </div>
                    <div class="popup-action">
                        <button onclick="shareLocation()" style="width: 100%; padding: 8px; background: linear-gradient(135deg, #4ade80, #22c55e); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            üì§ Share This Location
                        </button>
                    </div>
                </div>
            `);

            // Draw safety zones
            drawSafetyZones();

            // Initialize journey polyline
            journeyPolyline = L.polyline([], {
                color: '#667eea',
                weight: 4,
                opacity: 0.7,
                smoothFactor: 1,
                dashArray: '10, 10'
            }).addTo(safetyMapInstance);

            // Trigger initial location update
            updateMapLocation();
        }

        function drawSafetyZones() {
            if (!safetyMapInstance) return;

            // Clear existing zones
            safetyZones.forEach(zone => safetyMapInstance.removeLayer(zone));
            safetyZones = [];

            const zoneColors = {
                safe: { fill: 'rgba(74, 222, 128, 0.3)', stroke: '#4ade80' },
                moderate: { fill: 'rgba(251, 191, 36, 0.3)', stroke: '#fbbf24' },
                restricted: { fill: 'rgba(239, 68, 68, 0.3)', stroke: '#ef4444' }
            };

            sampleSafetyZones.forEach(zone => {
                const colors = zoneColors[zone.type] || zoneColors.safe;
                const polygon = L.polygon(zone.coordinates, {
                    color: colors.stroke,
                    fillColor: colors.fill,
                    fillOpacity: 0.4,
                    weight: 3
                }).addTo(safetyMapInstance);

                polygon.bindPopup(`
                    <div class="custom-popup">
                        <div class="popup-header">${zone.name}</div>
                        <div class="popup-body">
                            <p>üõ°Ô∏è Zone Type: <strong>${zone.type.toUpperCase()}</strong></p>
                            <p style="margin: 8px 0; padding: 8px; background: ${colors.fill}; border-radius: 6px; border: 2px solid ${colors.stroke};">
                                ${zone.type === 'safe' ? '‚úÖ Safe for tourists' : 
                                  zone.type === 'moderate' ? '‚ö†Ô∏è Exercise caution' : 
                                  'üö´ Restricted access'}
                            </p>
                        </div>
                    </div>
                `);

                safetyZones.push(polygon);
            });
        }

        function updateMapLocation() {
            if (!isMapEnabled || !safetyMapInstance) return;

            // Get geolocation (or use simulated data in development)
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        updateMarkerPosition(lat, lng);
                    },
                    (error) => {
                        console.warn('Geolocation error:', error.message);
                        // Use simulated movement
                        simulateLocationUpdate();
                    }
                );
            } else {
                // Browser doesn't support geolocation
                simulateLocationUpdate();
            }
        }

        function simulateLocationUpdate() {
            // Simulate movement for demo purposes
            const basePos = userMarker.getLatLng();
            const randomLat = basePos.lat + (Math.random() - 0.5) * 0.002;
            const randomLng = basePos.lng + (Math.random() - 0.5) * 0.002;
            updateMarkerPosition(randomLat, randomLng);
        }

        function updateMarkerPosition(lat, lng) {
            if (!userMarker) return;

            const newPos = [lat, lng];
            userMarker.setLatLng(newPos);
            safetyMapInstance.panTo(newPos, { animate: true, duration: 1 });

            // Add to journey history
            locationHistory.push({ lat, lng, timestamp: new Date() });
            if (locationHistory.length > 50) {
                locationHistory.shift(); // Keep last 50 locations
            }

            // Update polyline
            if (journeyPolyline) {
                const polylineCoords = locationHistory.map(loc => [loc.lat, loc.lng]);
                journeyPolyline.setLatLngs(polylineCoords);
            }

            // Update stats
            updateMapStats();

            // Check for geofence breach
            checkGeofenceBreach(lat, lng);

            // Update breadcrumb
            updateJourneyBreadcrumb();
        }

        function checkGeofenceBreach(lat, lng) {
            // Check if user is in a restricted zone
            const point = L.latLng(lat, lng);
            
            sampleSafetyZones.forEach(zone => {
                const polygon = L.polygon(zone.coordinates);
                const isInside = polygon.getBounds().contains(point);
                
                if (isInside && zone.type === 'restricted') {
                    showGeofenceAlert(zone.name);
                }
            });

            // Update current zone status
            const currentZone = sampleSafetyZones.find(zone => {
                const polygon = L.polygon(zone.coordinates);
                return polygon.getBounds().contains(point);
            });

            const zoneElement = document.getElementById('currentZone');
            if (zoneElement) {
                if (currentZone) {
                    zoneElement.textContent = currentZone.type === 'safe' ? 'Safe ‚úÖ' : 
                                              currentZone.type === 'moderate' ? 'Moderate ‚ö†Ô∏è' : 
                                              'Restricted üö´';
                    zoneElement.style.color = currentZone.type === 'safe' ? '#4ade80' : 
                                               currentZone.type === 'moderate' ? '#fbbf24' : 
                                               '#ef4444';
                } else {
                    zoneElement.textContent = 'Unknown';
                    zoneElement.style.color = '#9ca3af';
                }
            }
        }

        function showGeofenceAlert(zoneName) {
            const alert = document.createElement('div');
            alert.className = 'geofence-alert';
            alert.innerHTML = `
                <div class="alert-icon">‚ö†Ô∏è</div>
                <h3 style="margin: 0 0 8px 0; font-size: 1.5em;">Geofence Alert!</h3>
                <p style="margin: 0 0 16px 0;">You've entered a restricted zone: <strong>${zoneName}</strong></p>
                <button onclick="this.parentElement.remove()" style="background: white; color: #ff6b6b; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 700; cursor: pointer;">
                    Understood
                </button>
            `;
            document.getElementById('safetyMapContainer').appendChild(alert);

            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                if (alert.parentElement) alert.remove();
            }, 5000);

            // Update alerts count
            const alertsElement = document.getElementById('safetyAlerts');
            if (alertsElement) {
                const currentCount = parseInt(alertsElement.textContent) || 0;
                alertsElement.textContent = currentCount + 1;
            }
        }

        function updateMapStats() {
            // Update distance traveled
            if (locationHistory.length >= 2) {
                let totalDistance = 0;
                for (let i = 1; i < locationHistory.length; i++) {
                    const prev = locationHistory[i - 1];
                    const curr = locationHistory[i];
                    totalDistance += calculateDistance(prev.lat, prev.lng, curr.lat, curr.lng);
                }
                const distElement = document.getElementById('distanceTraveled');
                if (distElement) {
                    distElement.textContent = totalDistance.toFixed(2) + ' km';
                }
            }

            // Update locations tracked
            const locElement = document.getElementById('locationsTracked');
            if (locElement) {
                locElement.textContent = locationHistory.length;
            }
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function updateJourneyBreadcrumb() {
            const breadcrumbList = document.getElementById('breadcrumbList');
            if (!breadcrumbList) return;

            const recentLocations = locationHistory.slice(-5).reverse();
            breadcrumbList.innerHTML = recentLocations.map((loc, index) => {
                const timeAgo = Math.floor((new Date() - loc.timestamp) / 60000);
                return `
                    <div class="breadcrumb-item">
                        <span>${index === 0 ? 'üìç' : 'üîµ'}</span>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 0.9em;">
                                ${index === 0 ? 'Current' : `${timeAgo} min ago`}
                            </div>
                            <div class="breadcrumb-time">
                                ${loc.lat.toFixed(4)}, ${loc.lng.toFixed(4)}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleSafetyMap() {
            isMapEnabled = !isMapEnabled;
            
            const mapContainer = document.getElementById('safetyMapContainer');
            const mapOverlay = document.getElementById('mapOverlay');
            const toggleBtn = document.getElementById('mapToggleBtn');
            const liveBadge = document.getElementById('mapLiveBadge');
            const quickActions = document.getElementById('mapQuickActions');
            const legend = document.getElementById('mapLegend');
            const breadcrumb = document.getElementById('journeyBreadcrumb');
            const statsBar = document.getElementById('mapStatsBar');

            if (isMapEnabled) {
                // Enable map
                mapContainer.classList.remove('disabled');
                mapOverlay.style.display = 'none';
                toggleBtn.textContent = 'Disable AI Tracking';
                toggleBtn.style.background = 'rgba(255,107,107,0.3)';
                liveBadge.style.display = 'inline-flex';
                quickActions.style.display = 'flex';
                legend.style.display = 'block';
                breadcrumb.style.display = 'block';
                statsBar.style.display = 'grid';

                // Initialize map if not already done
                if (!safetyMapInstance) {
                    setTimeout(initializeSafetyMap, 100);
                }

                // Start auto-update (every 10 seconds)
                mapUpdateInterval = setInterval(updateMapLocation, 10000);

                showAchievementPopup('Map Enabled!', 'Real-time location tracking activated üó∫Ô∏è', '‚úÖ');
                
                // Update location status to Active
                updateSystemStatusDisplay({
                    ai_monitoring: { enabled: true },
                    auto_sos: { enabled: true },
                    location_tracking: { enabled: true },
                    safety_map: { enabled: true }
                });
            } else {
                // Disable map
                mapContainer.classList.add('disabled');
                mapOverlay.style.display = 'flex';
                toggleBtn.textContent = 'Enable AI Tracking';
                toggleBtn.style.background = 'rgba(255,255,255,0.2)';
                liveBadge.style.display = 'none';
                quickActions.style.display = 'none';
                legend.style.display = 'none';
                breadcrumb.style.display = 'none';
                statsBar.style.display = 'none';

                // Stop auto-update
                if (mapUpdateInterval) {
                    clearInterval(mapUpdateInterval);
                    mapUpdateInterval = null;
                }
                
                // Update location status to Ready
                updateSystemStatusDisplay({
                    ai_monitoring: { enabled: true },
                    auto_sos: { enabled: true },
                    location_tracking: { enabled: false },
                    safety_map: { enabled: false }
                });
            }
        }

        function findNearbyServices() {
            if (!safetyMapInstance || !userMarker) return;

            const userPos = userMarker.getLatLng();
            
            // Sample nearby services (in production, fetch from backend)
            const services = [
                { name: 'City Hospital', type: 'üè•', lat: userPos.lat + 0.005, lng: userPos.lng + 0.005 },
                { name: 'Police Station', type: 'üöî', lat: userPos.lat - 0.005, lng: userPos.lng + 0.005 },
                { name: 'Embassy', type: 'üèõÔ∏è', lat: userPos.lat + 0.005, lng: userPos.lng - 0.005 }
            ];

            services.forEach(service => {
                const marker = L.marker([service.lat, service.lng], {
                    icon: L.divIcon({
                        html: `<div style="font-size: 24px;">${service.type}</div>`,
                        iconSize: [30, 30],
                        className: ''
                    })
                }).addTo(safetyMapInstance);

                marker.bindPopup(`
                    <div class="custom-popup">
                        <div class="popup-header">${service.type} ${service.name}</div>
                        <div class="popup-body">
                            <p>üìû Contact: +91-XXX-XXXX</p>
                            <p>üìç Distance: ~${(Math.random() * 5 + 1).toFixed(1)} km</p>
                        </div>
                        <div class="popup-action">
                            <button onclick="alert('Opening directions...')" style="width: 100%; padding: 8px; background: #667eea; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                üß≠ Get Directions
                            </button>
                        </div>
                    </div>
                `);
            });

            showAchievementPopup('Services Found!', '3 nearby services added to map üìç', 'üè•');
        }

        // ========================================
        // üö® RISK ALERTS SYSTEM
        // ========================================

        let alertsDatabase = [];
        let alertIdCounter = 1;
        let contactMarkers = {}; // Store contact markers on map

        function addRiskAlert(type, message, location, suggestedAction, severity = 'warning') {
            const alert = {
                id: alertIdCounter++,
                type: type,
                message: message,
                location: location,
                suggestedAction: suggestedAction,
                severity: severity,
                timestamp: new Date(),
                read: false
            };

            alertsDatabase.unshift(alert); // Add to beginning
            updateAlertsPanel();
            updateAlertCounts();

            // Show notification popup if critical
            if (severity === 'critical') {
                showCriticalAlertPopup(alert);
            }

            return alert;
        }

        function updateAlertsPanel() {
            const alertsList = document.getElementById('alertsList');
            if (!alertsList) return;

            const activeFilter = document.querySelector('.alert-filter-btn.active')?.dataset.filter || 'all';
            let filteredAlerts = alertsDatabase;

            if (activeFilter !== 'all') {
                filteredAlerts = alertsDatabase.filter(a => a.severity === activeFilter);
            }

            if (filteredAlerts.length === 0) {
                alertsList.innerHTML = `
                    <div class="empty-state" style="text-align: center; padding: 60px 20px; color: #9ca3af;">
                        <div style="font-size: 4em; margin-bottom: 16px;">‚úÖ</div>
                        <h3 style="color: #6c757d; margin: 0 0 8px 0;">No ${activeFilter === 'all' ? 'Active' : activeFilter.charAt(0).toUpperCase() + activeFilter.slice(1)} Alerts</h3>
                        <p style="margin: 0;">You're in a safe zone. Alerts will appear here when you enter risky areas.</p>
                    </div>
                `;
                return;
            }

            alertsList.innerHTML = filteredAlerts.map(alert => {
                const icon = alert.severity === 'critical' ? 'üö®' : alert.severity === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
                const timeAgo = getTimeAgo(alert.timestamp);

                return `
                    <div class="alert-item ${alert.severity}" data-alert-id="${alert.id}" onclick="highlightAlertOnMap('${alert.location}')">
                        <div class="alert-icon-wrapper ${alert.severity === 'critical' ? 'flashing' : ''}">
                            ${icon}
                        </div>
                        <div class="alert-content">
                            <div class="alert-type">
                                ${alert.type}
                                ${alert.severity === 'critical' ? '<span style="background: #dc3545; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7em;">CRITICAL</span>' : ''}
                            </div>
                            <div class="alert-timestamp">üïí ${timeAgo}</div>
                            <div class="alert-location">üìç ${alert.location}</div>
                            <div style="margin-top: 8px; color: #2c3e50;">${alert.message}</div>
                            <button class="alert-action" onclick="event.stopPropagation(); executeAlertAction('${alert.suggestedAction}', ${alert.id})">
                                ${alert.suggestedAction}
                            </button>
                        </div>
                        <button class="alert-dismiss" onclick="event.stopPropagation(); dismissAlert(${alert.id})" title="Dismiss">
                            ‚úñ
                        </button>
                    </div>
                `;
            }).join('');
        }

        function filterAlerts(filterType) {
            // Update active filter button
            document.querySelectorAll('.alert-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-filter="${filterType}"]`).classList.add('active');

            updateAlertsPanel();
        }

        function updateAlertCounts() {
            const all = alertsDatabase.length;
            const critical = alertsDatabase.filter(a => a.severity === 'critical').length;
            const warning = alertsDatabase.filter(a => a.severity === 'warning').length;

            document.getElementById('alertCountAll').textContent = all;
            document.getElementById('alertCountCritical').textContent = critical;
            document.getElementById('alertCountWarning').textContent = warning;

            // Update stats bar alert count
            const alertsElement = document.getElementById('safetyAlerts');
            if (alertsElement) {
                alertsElement.textContent = all;
            }
        }

        function dismissAlert(alertId) {
            alertsDatabase = alertsDatabase.filter(a => a.id !== alertId);
            updateAlertsPanel();
            updateAlertCounts();
        }

        function clearAllAlerts() {
            if (confirm('Are you sure you want to clear all alerts?')) {
                alertsDatabase = [];
                updateAlertsPanel();
                updateAlertCounts();
                showAchievementPopup('Alerts Cleared', 'All safety alerts have been dismissed', '‚úÖ');
            }
        }

        function highlightAlertOnMap(location) {
            if (!safetyMapInstance) return;

            // Flash the location on map (add temporary marker)
            const coords = parseLocationString(location);
            if (!coords) return;

            const flashMarker = L.marker(coords, {
                icon: L.divIcon({
                    html: '<div style="background: #dc3545; width: 40px; height: 40px; border-radius: 50%; border: 4px solid white; box-shadow: 0 0 20px rgba(220,53,69,0.8); animation: pulse 1s infinite; display: flex; align-items: center; justify-content: center; font-size: 20px;">‚ö†Ô∏è</div>',
                    iconSize: [40, 40],
                    className: ''
                })
            }).addTo(safetyMapInstance);

            safetyMapInstance.setView(coords, 15, { animate: true });

            // Remove after 3 seconds
            setTimeout(() => {
                safetyMapInstance.removeLayer(flashMarker);
            }, 3000);
        }

        function parseLocationString(locationStr) {
            // Parse "28.6139, 77.2090" or location names
            const coords = locationStr.match(/([-\d.]+),\s*([-\d.]+)/);
            if (coords) {
                return [parseFloat(coords[1]), parseFloat(coords[2])];
            }
            return null;
        }

        function executeAlertAction(action, alertId) {
            switch(action) {
                case 'Notify Trusted Contacts':
                    notifyAllContacts();
                    break;
                case 'Navigate to Safe Zone':
                    navigateToSafeZone();
                    break;
                case 'Call Emergency':
                    if (confirm('Call emergency services?')) {
                        triggerEmergency();
                    }
                    break;
                case 'Share Location':
                    shareLocation();
                    break;
                default:
                    alert(`Action: ${action}`);
            }

            // Mark alert as read
            const alert = alertsDatabase.find(a => a.id === alertId);
            if (alert) {
                alert.read = true;
            }
        }

        function showCriticalAlertPopup(alert) {
            const popup = document.createElement('div');
            popup.className = 'geofence-alert';
            popup.innerHTML = `
                <div class="alert-icon" style="animation: shake 0.5s infinite;">üö®</div>
                <h3 style="margin: 12px 0; font-size: 1.8em;">CRITICAL ALERT!</h3>
                <p style="margin: 0 0 16px 0; font-size: 1.1em;">${alert.message}</p>
                <div style="display: flex; gap: 12px; justify-content: center;">
                    <button onclick="notifyAllContacts(); this.parentElement.parentElement.remove();" style="background: white; color: #dc3545; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 1em;">
                        üì§ Notify Contacts
                    </button>
                    <button onclick="this.parentElement.parentElement.remove();" style="background: rgba(255,255,255,0.3); color: white; border: 2px solid white; padding: 12px 24px; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 1em;">
                        Dismiss
                    </button>
                </div>
            `;
            document.getElementById('safetyMapContainer').appendChild(popup);

            // Auto-dismiss after 10 seconds
            setTimeout(() => {
                if (popup.parentElement) popup.remove();
            }, 10000);
        }

        function navigateToSafeZone() {
            if (!safetyMapInstance || !userMarker) return;

            // Find nearest safe zone
            const userPos = userMarker.getLatLng();
            let nearestSafeZone = null;
            let minDistance = Infinity;

            sampleSafetyZones.forEach(zone => {
                if (zone.type === 'safe') {
                    const zoneCenter = zone.coordinates.reduce((acc, coord) => {
                        return [acc[0] + coord[0] / zone.coordinates.length, acc[1] + coord[1] / zone.coordinates.length];
                    }, [0, 0]);

                    const dist = calculateDistance(userPos.lat, userPos.lng, zoneCenter[0], zoneCenter[1]);
                    if (dist < minDistance) {
                        minDistance = dist;
                        nearestSafeZone = { center: zoneCenter, name: zone.name };
                    }
                }
            });

            if (nearestSafeZone) {
                // Draw route line to safe zone
                const routeLine = L.polyline([
                    [userPos.lat, userPos.lng],
                    nearestSafeZone.center
                ], {
                    color: '#4ade80',
                    weight: 5,
                    opacity: 0.8,
                    dashArray: '10, 10'
                }).addTo(safetyMapInstance);

                safetyMapInstance.fitBounds(routeLine.getBounds(), { padding: [50, 50] });

                showAchievementPopup('Route Found', `Navigate to ${nearestSafeZone.name} (${minDistance.toFixed(2)} km away)`, 'üß≠');

                // Remove route after 30 seconds
                setTimeout(() => {
                    safetyMapInstance.removeLayer(routeLine);
                }, 30000);
            }
        }

        function getTimeAgo(timestamp) {
            const now = new Date();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes} min ago`;
            if (hours < 24) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            return `${days} day${days > 1 ? 's' : ''} ago`;
        }

        // ========================================
        // üó∫Ô∏è JOURNEY HISTORY SYSTEM
        // ========================================
        
        let journeyHistory = {};
        let selectedDate = new Date().toISOString().split('T')[0];

        function loadJourneyForDate(dateStr) {
            selectedDate = dateStr;
            const journey = journeyHistory[dateStr];

            if (!journey || journey.length === 0) {
                document.getElementById('journeyTimeline').innerHTML = `
                    <div class="empty-state" style="text-align: center; padding: 60px 20px; color: #9ca3af;">
                        <div style="font-size: 4em; margin-bottom: 16px;">üìÖ</div>
                        <h3 style="color: #6c757d; margin: 0 0 8px 0;">No Data for ${dateStr}</h3>
                        <p style="margin: 0;">No journey recorded for this date. Select another date or start tracking.</p>
                    </div>
                `;
                resetJourneyStats();
                return;
            }

            updateJourneyTimeline(journey);
            updateJourneyStats(journey);
            drawJourneyPath(journey);
        }

        function updateJourneyTimeline(journey) {
            const timeline = document.getElementById('journeyTimeline');
            timeline.innerHTML = journey.map((stop, index) => {
                const marker = stop.zone === 'safe' ? 'üü¢' : stop.zone === 'moderate' ? 'üü°' : 'üî¥';
                return `
                    <div class="timeline-item">
                        <div class="timeline-marker ${stop.zone}">
                            ${marker}
                        </div>
                        <div class="timeline-content">
                            <div class="timeline-time">${stop.time}</div>
                            <div class="timeline-location">${stop.location}</div>
                            <div class="timeline-details">
                                Zone: <strong>${stop.zone.charAt(0).toUpperCase() + stop.zone.slice(1)}</strong> ‚Ä¢ 
                                Duration: <strong>${stop.duration || 'In progress'}</strong>
                            </div>
                            ${stop.coordinates ? `<button class="timeline-view-btn" onclick="viewStopOnMap([${stop.coordinates}])">View on Map</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateJourneyStats(journey) {
            let totalDistance = 0;
            let safeZonesCount = 0;
            let riskyTime = 0;
            let totalStops = journey.length;

            journey.forEach((stop, index) => {
                if (stop.zone === 'safe') safeZonesCount++;
                if (stop.zone === 'risky' || stop.zone === 'moderate') {
                    riskyTime += stop.durationMinutes || 0;
                }

                if (index > 0 && stop.coordinates && journey[index - 1].coordinates) {
                    const [lat1, lng1] = journey[index - 1].coordinates;
                    const [lat2, lng2] = stop.coordinates;
                    totalDistance += calculateDistance(lat1, lng1, lat2, lng2);
                }
            });

            document.getElementById('journeyDistance').textContent = totalDistance.toFixed(2) + ' km';
            document.getElementById('safeBreadcrumbs').textContent = safeZonesCount;
            document.getElementById('riskyTime').textContent = riskyTime + ' min';
            document.getElementById('totalStops').textContent = totalStops;
        }

        function resetJourneyStats() {
            document.getElementById('journeyDistance').textContent = '0 km';
            document.getElementById('safeBreadcrumbs').textContent = '0';
            document.getElementById('riskyTime').textContent = '0 min';
            document.getElementById('totalStops').textContent = '0';
        }

        function drawJourneyPath(journey) {
            if (!safetyMapInstance) return;

            if (window.journeyDisplayLine) {
                safetyMapInstance.removeLayer(window.journeyDisplayLine);
            }

            const coords = journey.filter(s => s.coordinates).map(s => s.coordinates);
            if (coords.length < 2) return;

            window.journeyDisplayLine = L.polyline(coords, {
                color: '#667eea',
                weight: 4,
                opacity: 0.7,
                smoothFactor: 1
            }).addTo(safetyMapInstance);

            journey.forEach(stop => {
                if (stop.coordinates && stop.majorStop) {
                    const marker = L.marker(stop.coordinates, {
                        icon: L.divIcon({
                            html: `<div style="background: ${stop.zone === 'safe' ? '#4ade80' : stop.zone === 'moderate' ? '#fbbf24' : '#ef4444'}; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>`,
                            iconSize: [24, 24],
                            className: ''
                        })
                    }).addTo(safetyMapInstance);

                    marker.bindPopup(`
                        <div class="custom-popup">
                            <div class="popup-header">${stop.location}</div>
                            <div class="popup-body">
                                <p>üïí ${stop.time}</p>
                                <p>üõ°Ô∏è Zone: ${stop.zone.toUpperCase()}</p>
                            </div>
                        </div>
                    `);
                }
            });

            safetyMapInstance.fitBounds(window.journeyDisplayLine.getBounds(), { padding: [50, 50] });
        }

        function viewStopOnMap(coords) {
            if (!safetyMapInstance) return;
            safetyMapInstance.setView(coords, 15, { animate: true });
        }

        function toggleJourneyView() {
            const summary = document.getElementById('journeySummary');
            const timeline = document.getElementById('journeyTimeline');
            const toggleBtn = document.getElementById('journeyViewToggle');

            if (summary.style.display === 'none') {
                summary.style.display = 'grid';
                timeline.style.display = 'block';
                toggleBtn.textContent = 'üìä Show Stats';
            } else {
                summary.style.display = 'none';
                timeline.style.display = 'none';
                toggleBtn.textContent = 'üìã Show Timeline';
            }
        }

        function logJourneyStop(location, zone, coordinates) {
            // Feature removed - Journey History not needed
        }

        // ========================================
        // üë• TRUSTED CONTACTS SYSTEM - REMOVED
        // ========================================

        function notifyAllContacts() {
            showNotification('Feature removed for simplified interface', 'info');
        }

        function shareLocationWithContacts() {
            showNotification('Feature removed for simplified interface', 'info');
        }

        // ========================================
        // ÔøΩ NOTIFICATION HELPERS
        // ========================================

        function getCurrentZoneStatus() {
            const message = `üö® SAFETY ALERT\n\nYour trusted contact is sharing their location with you.\n\nLocation: ${pos.lat.toFixed(4)}, ${pos.lng.toFixed(4)}\n\nTime: ${new Date().toLocaleString()}`;

            if (confirm('Share your current location with all trusted contacts?\n\n' + message)) {
                console.log('Notifying all contacts:', message);
                showAchievementPopup('Location Shared!', 'All trusted contacts have been notified üì§', '‚úÖ');

                addRiskAlert(
                    'Location Shared',
                    'Your location was shared with all trusted contacts',
                    `${pos.lat.toFixed(4)}, ${pos.lng.toFixed(4)}`,
                    'View Contacts',
                    'info'
                );
            }
        }

        function shareLocationWith(contactId) {
            if (!userMarker) {
                alert('Location not available. Please enable the Safety Map first.');
                return;
            }

            const pos = userMarker.getLatLng();
            const contactCard = document.querySelector(`[data-contact-id="${contactId}"]`);
            const contactName = contactCard.querySelector('.contact-name').textContent;

            console.log(`Sharing location with ${contactName}:`, pos);
            showAchievementPopup('Location Sent', `Location shared with ${contactName} üìç`, '‚úÖ');
        }

        function callContact(contactId) {
            const contactCard = document.querySelector(`[data-contact-id="${contactId}"]`);
            const contactName = contactCard.querySelector('.contact-name').textContent;
            alert(`üìû Calling ${contactName}...\n\n(In production, this would initiate a phone call)`);
        }

        function messageContact(contactId) {
            const contactCard = document.querySelector(`[data-contact-id="${contactId}"]`);
            const contactName = contactCard.querySelector('.contact-name').textContent;
            alert(`üí¨ Opening message to ${contactName}...\n\n(In production, this would open messaging app)`);
        }

        function viewContactOnMap(contactId) {
            if (!safetyMapInstance) {
                alert('Please enable the Safety Map first.');
                return;
            }

            const contactLocations = {
                '1': [28.6150, 77.2095],
                '3': [28.6180, 77.2120]
            };

            const contactLoc = contactLocations[contactId];
            if (!contactLoc) {
                alert('Contact location not available');
                return;
            }

            const contactCard = document.querySelector(`[data-contact-id="${contactId}"]`);
            const contactName = contactCard.querySelector('.contact-name').textContent;
            const contactAvatar = contactCard.querySelector('.contact-avatar img').src;

            if (contactMarkers[contactId]) {
                safetyMapInstance.removeLayer(contactMarkers[contactId]);
            }

            contactMarkers[contactId] = L.marker(contactLoc, {
                icon: L.divIcon({
                    html: `<div style="width: 40px; height: 40px; border-radius: 50%; border: 4px solid #4ade80; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                        <img src="${contactAvatar}" style="width: 100%; height: 100%; object-fit: cover;">
                    </div>`,
                    iconSize: [40, 40],
                    className: ''
                })
            }).addTo(safetyMapInstance);

            contactMarkers[contactId].bindPopup(`
                <div class="custom-popup">
                    <div class="popup-header">üë• ${contactName}</div>
                    <div class="popup-body">
                        <p>üìç Location shared</p>
                        <p>üïí Updated: Just now</p>
                        <p>üõ°Ô∏è Status: <strong style="color: #4ade80;">Safe Zone</strong></p>
                    </div>
                    <div class="popup-action">
                        <button onclick="callContact('${contactId}')" style="width: 100%; padding: 8px; background: #4ade80; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-bottom: 6px;">
                            üìû Call Now
                        </button>
                        <button onclick="messageContact('${contactId}')" style="width: 100%; padding: 8px; background: #667eea; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            üí¨ Send Message
                        </button>
                    </div>
                </div>
            `).openPopup();

            safetyMapInstance.setView(contactLoc, 14, { animate: true });
        }

        function addTrustedContact() {
            alert('üìù Add Trusted Contact\n\n(In production, this would open a form to add a new emergency contact with their details and relationship)');
        }

        // ========================================
        // ÔøΩ LOCATION SHARING FUNCTIONS
        // ========================================

        function shareLocation() {
            if (!isMapEnabled) {
                showNotification('‚ö†Ô∏è Please enable Safety Map first to share location', 'warning');
                return;
            }

            if (!userMarker) {
                showNotification('‚ö†Ô∏è Current location not available. Please wait for GPS...', 'warning');
                return;
            }

            // Get current location from map marker
            const currentPos = userMarker.getLatLng();
            const contacts = ['Mom', 'Dad', 'Sarah'];
            const locationData = {
                lat: currentPos.lat,
                lng: currentPos.lng,
                timestamp: new Date().toISOString(),
                zone: getCurrentZoneStatus()
            };

            console.log('üì§ Sharing location with all contacts:', locationData);
            
            // Create Google Maps link
            const mapsLink = `https://www.google.com/maps?q=${currentPos.lat},${currentPos.lng}`;
            
            // Get zone status for message
            const zoneStatus = getCurrentZoneStatus();
            const zoneEmoji = zoneStatus === 'safe' ? '‚úÖ' : zoneStatus === 'moderate' ? '‚ö†Ô∏è' : 'üö®';
            const zoneName = zoneStatus === 'safe' ? 'Safe Zone' : zoneStatus === 'moderate' ? 'Moderate Risk Zone' : 'Restricted Zone';
            
            // Create WhatsApp message
            const message = `üõ°Ô∏è *Tourist Safety Alert*\n\n` +
                `üìç *My Current Location:*\n` +
                `${mapsLink}\n\n` +
                `${zoneEmoji} *Safety Status:* ${zoneName}\n` +
                `üïê *Time:* ${new Date().toLocaleString()}\n\n` +
                `_Shared via Tourist Safety System_`;
            
            // Encode message for WhatsApp
            const whatsappURL = `https://wa.me/?text=${encodeURIComponent(message)}`;
            
            // Open WhatsApp sharing
            window.open(whatsappURL, '_blank');
            
            showNotification(`‚úÖ Opening WhatsApp to share location with contacts!`, 'success');
            
            // Add to recent activity
            const activityItem = document.createElement('div');
            activityItem.className = 'activity-item';
            activityItem.innerHTML = `
                <div class="activity-icon" style="background: linear-gradient(135deg, #4ade80, #22c55e);">üìç</div>
                <div class="activity-content">
                    <div class="activity-title">Location Shared via WhatsApp</div>
                    <div class="activity-time">Just now - ${zoneName}</div>
                </div>
            `;
            
            const activityList = document.querySelector('.activity-list');
            if (activityList && activityList.firstChild) {
                activityList.insertBefore(activityItem, activityList.firstChild);
            }
        }

        function viewEmergencyContacts() {
            // Removed: Emergency contacts feature not needed
            showNotification('Feature removed for simplified interface', 'info');
        }

        function addEmergencyContact() {
            // Removed: Emergency contacts feature not needed
            showNotification('Feature removed for simplified interface', 'info');
        }

        function getCurrentZoneStatus() {
            if (!userMarker) return 'safe';
            
            const currentPos = userMarker.getLatLng();
            const point = L.latLng(currentPos.lat, currentPos.lng);
            
            for (const zone of sampleSafetyZones) {
                const polygon = L.polygon(zone.coordinates);
                if (polygon.getBounds().contains(point)) {
                    return zone.type; // 'safe', 'moderate', or 'restricted'
                }
            }
            
            return 'safe'; // Default to safe if not in any defined zone
        }

        // ========================================
        // ÔøΩüîó INTEGRATION WITH EXISTING SAFETY MAP
        // ========================================

        const originalCheckGeofenceBreach = checkGeofenceBreach;
        checkGeofenceBreach = function(lat, lng) {
            originalCheckGeofenceBreach(lat, lng);

            const point = L.latLng(lat, lng);
            
            sampleSafetyZones.forEach(zone => {
                const polygon = L.polygon(zone.coordinates);
                const isInside = polygon.getBounds().contains(point);
                
                if (isInside) {
                    if (zone.type === 'restricted') {
                        addRiskAlert(
                            'Entered Restricted Area',
                            `You have entered ${zone.name}, which is marked as a restricted zone. Please exercise extreme caution.`,
                            `${lat.toFixed(4)}, ${lng.toFixed(4)}`,
                            'Notify Trusted Contacts',
                            'critical'
                        );

                        logJourneyStop(zone.name, 'risky', [lat, lng]);
                    } else if (zone.type === 'moderate') {
                        addRiskAlert(
                            'Caution Zone Entered',
                            `You are now in ${zone.name}. Stay alert and avoid dark or isolated areas.`,
                            `${lat.toFixed(4)}, ${lng.toFixed(4)}`,
                            'Share Location',
                            'warning'
                        );

                        logJourneyStop(zone.name, 'moderate', [lat, lng]);
                    } else {
                        logJourneyStop(zone.name, 'safe', [lat, lng]);
                    }
                }
            });
        };

        const originalToggleSafetyMap = toggleSafetyMap;
        toggleSafetyMap = function() {
            originalToggleSafetyMap();

            const riskPanel = document.getElementById('riskAlertsPanel');
            const journeyPanel = document.getElementById('journeyHistoryPanel');
            const contactsPanel = document.getElementById('trustedContactsPanel');

            if (isMapEnabled) {
                riskPanel.style.display = 'block';
                journeyPanel.style.display = 'block';
                contactsPanel.style.display = 'block';

                document.getElementById('journeyDatePicker').value = selectedDate;

                // Load sample journey data for demo
                const today = new Date().toISOString().split('T')[0];
                if (!journeyHistory[today]) {
                    journeyHistory[today] = [
                        {
                            time: '08:30 AM',
                            location: 'Home - Connaught Place',
                            zone: 'safe',
                            coordinates: [28.6139, 77.2090],
                            majorStop: true,
                            durationMinutes: 45
                        },
                        {
                            time: '09:45 AM',
                            location: 'Coffee Shop - Khan Market',
                            zone: 'safe',
                            coordinates: [28.6145, 77.2095],
                            majorStop: true,
                            durationMinutes: 25
                        },
                        {
                            time: '11:00 AM',
                            location: 'Shopping Mall - Saket',
                            zone: 'moderate',
                            coordinates: [28.6120, 77.2085],
                            majorStop: true,
                            durationMinutes: 60
                        }
                    ];
                    loadJourneyForDate(today);
                }
            } else {
                riskPanel.style.display = 'none';
                journeyPanel.style.display = 'none';
                contactsPanel.style.display = 'none';
            }
        };

    </script>
</body>
</html>